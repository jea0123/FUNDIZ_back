<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.CreatorMapper">

    <select id="findByIds" resultType="creator">
        SELECT *
        FROM creator
        WHERE creatorId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="findById" parameterType="Long" resultType="creator">
        SELECT *
        FROM creator
        WHERE creatorId = #{creatorId}
    </select>

<!--    <select id="">-->
<!--        SELECT-->
<!--            (-->
<!--            SELECT count(*)-->
<!--            FROM project-->
<!--            WHERE creatorId = #{creatorId}-->
<!--            ) AS totalProject,-->

<!--            (-->
<!--            SELECT sum(s.*)-->
<!--            FROM settlement s-->
<!--            JOIN project p ON p.projectId = s.projectId-->
<!--            JOIN creator c ON c.creatorId = p.creatorId-->
<!--            WHERE creatorId = #{creatorId}-->
<!--            ) AS totalAmount,-->

<!--            (-->
<!--            SELECT count(b.backingId)-->
<!--            FROM backing b-->
<!--            JOIN backingDetail bd ON b.backingId = bd.backingId-->
<!--            JOIN reward r ON bd.rewardId = r.rewardId-->
<!--            JOIN project p ON r.projectId = p.projectId-->
<!--            WHERE p.creatorId = #{creatorId}-->
<!--            ) AS totalBackers,-->

<!--            (-->
<!--            select count(*)-->
<!--            from project p-->
<!--            where p.creatorId = 96-->
<!--            and p.projectStatus ='VERIFYING';-->
<!--            ) AS pendingApproval-->
<!--        FROM dual;-->

<!--    </select>-->


<!--    <select id="CreatorPDetailDto" parameterType="Long" resultType="com.example.funding.dto.response.creator.CreatorPDetailDto">-->
<!--        SELECT-->
<!--        p.projectId-->
<!--        , p.creatorId-->
<!--        , p.subctgrId-->
<!--        , p.title-->
<!--        , p.goalAmount-->
<!--        , p.currAmount-->
<!--        , p.startDate-->
<!--        , p.endDate-->
<!--        , p.thumbnail-->
<!--        , p.createdAt AS createdAt-->
<!--        , p.updateAt-->
<!--        , p.projectStatus-->
<!--        , p.backerCnt-->
<!--        , p.likeCnt-->
<!--        , p.viewCnt-->
<!--        , p.isVerified-->
<!--        , p.rejectedReason-->
<!--        , p.requestedAt-->

<!--        , r.rewardId-->
<!--        , r.rewardName-->
<!--        , r.price-->
<!--        , r.rewardContent-->
<!--        , r.deliveryDate-->
<!--        , r.rewardCnt-->
<!--        , r.createdAt AS createdAtR-->
<!--        , r.isPosting-->
<!--        , r.remain-->

<!--        , c.creatorName-->

<!--        FROM project p-->
<!--        JOIN creator c ON c.creatorId = p.creatorId-->
<!--        JOIN Reward r ON p.projectId = r.projectId-->
<!--        WHERE p.creatorId = #{creatorId}-->
<!--        Order BY p.projectId desc-->


<!--    </select>-->

    <sql id="projectListWhere">
        <where>
            p.CREATORID = #{creatorId}
            <if test="dto.projectStatus != null and dto.projectStatus != ''">
                AND p.PROJECTSTATUS = #{dto.projectStatus}
            </if>
            <if test="dto.fromDate != null">
                AND p.UPDATEDAT <![CDATA[ >= ]]> #{dto.fromDate}
            </if>
            <if test="dto.toDate != null">
                AND p.UPDATEDAT <![CDATA[ < ]]> #{dto.toDateEndExclusive}
            </if>
        </where>
    </sql>

    <select id="countProject" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        <include refid="projectListWhere" />
    </select>

    <select id="getProjectList" resultType="creatorProjectListDto">
        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID AS projectId,
                    p.TITLE AS title,
                    p.PROJECTSTATUS AS projectStatus,
                    p.STARTDATE AS startDate,
                    p.ENDDATE AS endDate,
                    p.GOALAMOUNT AS goalAmount,
                    p.CURRAMOUNT AS currAmount,
                    p.BACKERCNT AS backerCnt,
                    cg.CTGRNAME AS ctgrName,
                    sc.SUBCTGRNAME AS subctgrName,
                    CASE
                        WHEN p.PROJECTSTATUS = 'VERIFYING'
                        THEN p.REQUESTEDAT
                        ELSE NULL
                    END AS requestedAt
                FROM PROJECT p
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
                <include refid="projectListWhere" />
                ORDER BY p.PROJECTID DESC
            ) T
            WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
        )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="getProjectDetail" resultType="creatorProjectDetailDto">
        SELECT p.*, c.*, sc.*, cg.*
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        WHERE p.PROJECTID = #{projectId}
        AND p.CREATORID = #{creatorId}
    </select>

    <insert id="saveProject">
        <selectKey keyProperty="projectId" resultType="Long" order="BEFORE">
            SELECT PROJECT_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO PROJECT (
            PROJECTID, CREATORID, SUBCTGRID, TITLE, GOALAMOUNT,
            STARTDATE, ENDDATE, CONTENT, THUMBNAIL, ISPOSTING
        ) VALUES (
            #{projectId}, #{creatorId}, #{subctgrId}, #{title}, #{goalAmount},
            #{startDate}, #{endDate}, #{content}, #{thumbnail}, #{isPosting}
        )
    </insert>

    <update id="updateProject">
        UPDATE PROJECT
        <set>
            <if test="project.subctgrId != null"> SUBCTGRID = #{project.subctgrId}, </if>
            <if test="project.title != null"> TITLE = #{project.title}, </if>
            <if test="project.content != null"> CONTENT = #{project.content}, </if>
            <if test="project.thumbnail != null"> THUMBNAIL = #{project.thumbnail}, </if>
            <if test="project.goalAmount != null"> GOALAMOUNT = #{project.goalAmount}, </if>
            <if test="project.startDate != null"> STARTDATE = #{project.startDate}, </if>
            <if test="project.endDate != null"> ENDDATE = #{project.endDate}, </if>
            UPDATEDAT = SYSDATE
        </set>
        WHERE PROJECTID = #{project.projectId}
        AND CREATORID = #{creatorId}
        AND PROJECTSTATUS = 'DRAFT'
    </update>

    <delete id="deleteProject">
        DELETE FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </delete>

    <update id="markVerifyProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'VERIFYING',
            ISVERIFIED = 'Y',
            REQUESTEDAT = SYSDATE
        WHERE PROJECTID = #{projectId}
        AND PROJECTSTATUS = 'DRAFT'
        AND ISVERIFIED = 'N'
    </update>

</mapper>