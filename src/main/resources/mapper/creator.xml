<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.CreatorMapper">

    <insert id="insertCreator" parameterType="creator">
        INSERT INTO CREATOR (
            CREATORID, USERID, CREATORNAME, CREATORTYPE, FOLLOWERCNT, BUSINESSNUM, PROFILEIMG, EMAIL, PHONE, ACCOUNT, BANK
        ) VALUES (
            CREATOR_SEQ.NEXTVAL, #{userId}, #{creatorName}, #{creatorType}, 0, #{businessNum}, #{profileImg}, #{email}, #{phone}, #{account}, #{bank}
        )
    </insert>

    <select id="creatorInfo" parameterType="Long" resultType="creator">
        SELECT * FROM creator
        WHERE creatorId = #{creatorId}
    </select>

    <update id="updateCreatorInfo" parameterType="com.example.funding.dto.request.creator.CreatorUpdateRequestDto">
        UPDATE creator
        SET CREATORNAME = #{creatorName},
        CREATORTYPE = #{creatorType},
        EMAIL = #{email},
        PHONE = #{phone},
        BANK = #{bank},
        ACCOUNT = #{account},
        BUSINESSNUM = #{businessNum},
        PROFILEIMG = #{profileImgUrl}
        WHERE CREATORID=#{creatorId}
    </update>

    <select id="findByIds" resultType="creator">
        SELECT *
        FROM creator
        WHERE creatorId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="findById" parameterType="Long" resultType="creator">
        SELECT *
        FROM creator
        WHERE creatorId = #{creatorId}
    </select>

    <sql id="splitStatus">
        SELECT REGEXP_SUBSTR(#{dto.projectStatus}, '[^,]+', 1, LEVEL) AS token
        FROM dual
        CONNECT BY REGEXP_SUBSTR(#{dto.projectStatus}, '[^,]+', 1, LEVEL) IS NOT NULL
    </sql>

    <sql id="projectListWhere">
        <where>
            p.CREATORID = #{creatorId}
            <if test="dto.projectStatus != null and dto.projectStatus != ''">
                AND p.PROJECTSTATUS IN (<include refid="splitStatus" />)
            </if>
            <if test="dto.fromDate != null">
                AND p.UPDATEDAT <![CDATA[ >= ]]> #{dto.fromDate}
            </if>
            <if test="dto.toDate != null">
                AND p.UPDATEDAT <![CDATA[ < ]]> #{dto.toDateEndExclusive}
            </if>
        </where>
    </sql>

    <select id="countProject" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        <include refid="projectListWhere" />
    </select>

    <select id="getProjectList" resultType="creatorProjectListDto">
        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID,
                    p.TITLE,
                    p.GOALAMOUNT,
                    p.CURRAMOUNT,
                    p.STARTDATE,
                    p.ENDDATE,
                    p.CREATEDAT,
                    p.UPDATEDAT,
                    p.PROJECTSTATUS,
                    p.BACKERCNT,
                    p.LIKECNT,
                    p.VIEWCNT,

                    <!-- 심사요청일 -->
                    CASE
                        WHEN p.PROJECTSTATUS = 'VERIFYING' THEN p.REQUESTEDAT
                        ELSE NULL
                    END AS requestedAt,

                    <!-- 반려사유 -->
                    CASE
                        WHEN p.PROJECTSTATUS = 'REJECTED' THEN p.REJECTEDREASON
                        ELSE NULL
                    END AS rejectedReason,

                    sc.SUBCTGRNAME,
                    cg.CTGRNAME,

                    <!-- 새소식 집계: 개수, 최근 작성일 -->
                    NVL(n.newsCount, 0) AS newsCount,
                    n.lastNewsAt,

                    <!-- 후기 집계: 총 후기 수, 미답글 수, 최근 작성일 -->
                    NVL(rv.reviewNewCount, 0) AS reviewNewCount,
                    NVL(rv.reviewPendingCount, 0) AS reviewPendingCount,
                    rv.lastReviewAt

                FROM PROJECT p
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID

                <!-- 새소식 집계 -->
                LEFT JOIN (
                    SELECT
                        PROJECTID,
                        COUNT(*) AS newsCount,
                        MAX(TRUNC(CREATEDAT)) AS lastNewsAt
                    FROM NEWS
                    GROUP BY PROJECTID
                ) n ON n.PROJECTID = p.PROJECTID

                <!-- 후기 집계: COMMUNITY(code='RV') + REPLY(code='RV') -->
                LEFT JOIN (
                    SELECT
                        r.PROJECTID,
                        COUNT(*) AS reviewNewCount,

                        <!-- reply가 전혀 없는 후기만 1로 집계 -->
                        SUM(CASE WHEN rp.CMID IS NULL THEN 1 ELSE 0 END) AS reviewPendingCount,

                        MAX(TRUNC(r.CREATEDAT)) AS lastReviewAt
                    FROM COMMUNITY r

                    <!-- 후기 글만 -->
                    LEFT JOIN (
                        SELECT CMID
                        FROM REPLY
                        WHERE CODE = 'RV'
                        GROUP BY CMID
                    ) rp ON rp.CMID = r.CMID
                    WHERE r.CODE = 'RV'
                    GROUP BY r.PROJECTID
                ) rv ON rv.PROJECTID = p.PROJECTID
                <include refid="projectListWhere" />
                ORDER BY p.UPDATEDAT DESC
            ) T
            WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
        )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="getProjectDetail" resultType="creatorProjectDetailDto">
        SELECT
            p.PROJECTID,
            p.CREATORID,
            p.TITLE,
            p.GOALAMOUNT,
            p.CURRAMOUNT,
            p.STARTDATE,
            p.ENDDATE,
            p.CREATEDAT,
            p.UPDATEDAT,
            p.PROJECTSTATUS,
            p.CONTENT,
            p.CONTENTBLOCKS,
            p.THUMBNAIL,
            p.BUSINESSDOC,
            sc.SUBCTGRNAME,
            cg.CTGRNAME,
            c.CREATORNAME,
            c.BUSINESSNUM,
            c.EMAIL,
            c.PHONE
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        WHERE p.PROJECTID = #{projectId}
        AND p.CREATORID = #{creatorId}
    </select>

    <insert id="saveProject">
        <selectKey keyProperty="projectId" resultType="Long" order="BEFORE">
            SELECT PROJECT_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO PROJECT (
            PROJECTID, CREATORID, SUBCTGRID, TITLE, GOALAMOUNT, STARTDATE, ENDDATE,
            CONTENT, CONTENTBLOCKS, THUMBNAIL, BUSINESSDOC
        ) VALUES (
            #{projectId}, #{creatorId}, #{subctgrId}, #{title}, #{goalAmount}, #{startDate}, #{endDate},
            #{content}, #{contentBlocks}, #{thumbnail}, #{businessDoc}
        )
    </insert>

    <update id="updateProject">
        UPDATE PROJECT
        <set>
            <if test="subctgrId != null"> SUBCTGRID = #{subctgrId}, </if>
            <if test="title != null"> TITLE = #{title}, </if>
            <if test="goalAmount != null"> GOALAMOUNT = #{goalAmount}, </if>
            <if test="startDate != null"> STARTDATE = #{startDate}, </if>
            <if test="endDate != null"> ENDDATE = #{endDate}, </if>
            <if test="content != null"> CONTENT = #{content}, </if>
            <if test="contentBlocks != null and contentBlocks != ''">
                CONTENTBLOCKS = #{contentBlocks},
            </if>
            <if test="thumbnail != null"> THUMBNAIL = #{thumbnail}, </if>
            <if test="businessDoc != null"> BUSINESSDOC = #{businessDoc}, </if>
            UPDATEDAT = SYSDATE
        </set>
        WHERE PROJECTID = #{projectId}
        AND CREATORID = #{creatorId}
        AND PROJECTSTATUS = 'DRAFT'
    </update>

    <delete id="deleteProject">
        DELETE FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </delete>

    <update id="markVerifyProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'VERIFYING',
            ISVERIFIED = 'Y',
            REQUESTEDAT = SYSDATE,
            UPDATEDAT = SYSDATE
        WHERE PROJECTID = #{projectId}
        AND PROJECTSTATUS = 'DRAFT'
        AND ISVERIFIED = 'N'
    </update>

    <select id="existsCreator" resultType="int">
        SELECT COUNT(*)
        FROM CREATOR
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="getCreatorProfileSummary" resultType="creatorProfileSummaryDto">
        SELECT CREATORNAME, BUSINESSNUM, EMAIL, PHONE
        FROM CREATOR
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="getQnaListOfCreator" resultType="CreatorQnaDto">
        SELECT * FROM
        (SELECT sub.*, ROWNUM rnum FROM (
        SELECT
        q.QNAID AS qnaId,
        q.PROJECTID AS projectId,
        q.USERID AS userId,
        q.CREATORID AS creatorId,
        q.CONTENT AS content,
        CAST(q.CREATEDAT AS DATE) AS createdAt,
        p.TITLE AS title
        from qna q
        join project p on q.projectid = p.projectid
        WHERE q.CREATORID = #{creatorId} order by q.QNAID desc
        ) sub  WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow})
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="qnaTotalOfCreator" resultType="Integer">
        SELECT COUNT(*) FROM qna
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="getProjectRankDate" parameterType="long" resultType="com.example.funding.dto.response.creator.CreatorDashboardRankDto">
        SELECT
            creatorId,
            title,
            backerCnt,
            likeCnt,
            viewCnt
        FROM PROJECT
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="creatorDashboardDto" parameterType="long" resultType="com.example.funding.dto.response.creator.CreatorDashboardDto">
        SELECT
            NVL(count(*),0) AS totalProjectCnt,
            NVL(count(CASE WHEN projectStatus = 'FAILED' THEN creatorId END),0) AS projectFailedCnt
        FROM
            project
        WHERE CREATORID = #{creatorId}
<!--        GROUP BY creatorId-->
    </select>

    <update id="increaseFollowersCount" parameterType="long">
        UPDATE CREATOR
        SET FOLLOWERCNT = FOLLOWERCNT + 1
        WHERE CREATORID = #{creatorId}
    </update>

    <update id="decreaseFollowersCount" parameterType="long">
        UPDATE CREATOR
        SET FOLLOWERCNT = FOLLOWERCNT - 1
        WHERE CREATORID = #{creatorId} AND FOLLOWERCNT > 0
    </update>

    <select id="getCreatorRowById" resultType="com.example.funding.dto.response.creator.CreatorSummaryDto$CreatorRow" parameterType="long">
        SELECT
            CREATORID AS creatorId,
            CREATORNAME AS creatorName,
            PROFILEIMG AS profileImg,
            BIO AS bio
        FROM CREATOR
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="getCreatorStatsById" resultType="com.example.funding.dto.response.creator.CreatorSummaryDto$Stats" parameterType="long">
        SELECT
        /* 창작자가 올린 프로젝트 개수 */
        NVL((
        SELECT COUNT(*)
        FROM project p
        WHERE p.creatorId = #{creatorId}
        ), 0) AS projectCount,

        NVL((
        SELECT COUNT(DISTINCT b.userId)
        FROM project        p
        JOIN reward         r   ON r.projectId    = p.projectId
        JOIN backingDetail  bd  ON bd.rewardId    = r.rewardId
        JOIN backing        b   ON b.backingId    = bd.backingId
        JOIN payment        pay ON pay.backingId  = b.backingId
        WHERE p.creatorId = #{creatorId}
        AND pay.status  = 'PAID'
        ), 0) AS totalBackers,

        COALESCE((
        SELECT SUM(pay.amount)
        FROM project p
        JOIN reward r ON r.projectId = p.projectId
        JOIN backingDetail bd ON bd.rewardId = r.rewardId
        JOIN backing b ON b.backingId = bd.backingId
        JOIN payment pay ON pay.backingId = b.backingId
        WHERE p.creatorId = #{creatorId}
        AND pay.status  = 'PAID'
        ), 0) AS totalAmount
        FROM dual
    </select>

    <select id="findCreatorProjects"
            parameterType="map"
            resultType="com.example.funding.dto.response.creator.CreatorProjectDto">
        SELECT * FROM (
        SELECT inner_table.*, ROWNUM rn
        FROM (
        WITH agg AS (
        SELECT
        r.projectId,
        COUNT(DISTINCT CASE WHEN pay.status = 'PAID' THEN b.userId END) AS backerCnt,
        SUM(CASE WHEN pay.status = 'PAID' THEN pay.amount ELSE 0 END)   AS currAmount
        FROM reward r
        JOIN backingDetail bd ON bd.rewardId  = r.rewardId
        JOIN backing b  ON b.backingId  = bd.backingId
        LEFT JOIN payment pay ON pay.backingId = b.backingId
        GROUP BY r.projectId
        )
        SELECT
        p.projectId,
        p.title,
        p.thumbnail,
        NVL(a.currAmount, 0) AS currAmount,
        p.goalAmount,
        NVL(a.backerCnt, 0)  AS backerCnt,
        p.projectStatus,
        p.endDate,
        CASE
        WHEN p.projectStatus IN ('SUCCESS','SETTLED')
        OR NVL(a.currAmount,0) >= NVL(p.goalAmount,0)
        THEN 1 ELSE 0
        END AS isSuccess,
        CASE
        WHEN NVL(p.goalAmount,0) = 0 THEN 0
        ELSE ROUND((NVL(a.currAmount,0) / p.goalAmount) * 100)
        END AS achievePercent
        FROM project p
        LEFT JOIN agg a ON a.projectId = p.projectId
        WHERE p.creatorId = #{creatorId}
        <choose>
            <when test="sort == null or sort == '' or sort == 'recent'">
                ORDER BY p.createdAt DESC, p.projectId DESC
            </when>
            <when test="sort == 'popular'">
                ORDER BY NVL(a.backerCnt,0) DESC, NVL(a.currAmount,0) DESC, NVL(p.viewCnt,0) DESC
            </when>
            <when test="sort == 'percent'">
                ORDER BY
                CASE WHEN NVL(p.goalAmount,0)=0 THEN 0 ELSE NVL(a.currAmount,0)/p.goalAmount END DESC,
                NVL(a.currAmount,0) DESC
            </when>
            <when test="sort == 'closing'">
                ORDER BY
                CASE WHEN p.projectStatus IN ('OPEN','UPCOMING','VERIFYING') THEN 0 ELSE 1 END,
                p.endDate ASC NULLS LAST
            </when>
        </choose>
        ) inner_table
        WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
        )
        WHERE rn >= #{pager.startRow}
    </select>

</mapper>