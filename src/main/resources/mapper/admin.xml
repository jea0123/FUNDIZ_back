<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.AdminMapper">

    <!-- KPI 조회 쿼리 -->
    <select id="getKpiByMonths" parameterType="java.lang.Integer" resultType="kpi">
        SELECT
            NVL(SUM(CASE WHEN STATUS='PAID' THEN AMOUNT END),0) AS totalBackingAmount,
            ROUND(NVL(SUM(CASE WHEN STATUS='PAID' THEN AMOUNT END),0) * 0.05, 0) AS fee,
            CASE WHEN COUNT(*) > 0
                THEN ROUND((COUNT(CASE WHEN STATUS='PAID' THEN 1 END)/COUNT(*))*100.0,1)
                ELSE 0 END AS successRate,
            ROUND(NVL(AVG(CASE WHEN STATUS='PAID' THEN AMOUNT END),0),0) AS backingAmountAvg
        FROM PAYMENT
        <if test="months != null and months != 0">
            WHERE createdAt >= ADD_MONTHS(TRUNC(SYSDATE,'MM'), -(#{months} - 1))
            <![CDATA[
                AND createdAt <  ADD_MONTHS(TRUNC(SYSDATE,'MM'), 1)
            ]]>
        </if>
    </select>

    <!-- 월별 트렌드 조회 쿼리 -->
    <select id="getMonthlyTrends" parameterType="java.lang.Integer" resultType="revenueTrend">
        <choose>
            <when test="months != null and months != 0">
                WITH months AS (
                    SELECT ADD_MONTHS(TRUNC(SYSDATE,'MM'), -(#{months} - LEVEL)) AS m
                    FROM dual
                    <![CDATA[
                        CONNECT BY LEVEL <= #{months}
                        )
                    ]]>
                SELECT
                    TO_CHAR(m.m,'YYYY-MM') AS month,
                    COUNT(DISTINCT CASE WHEN p.STATUS='PAID' THEN rw.projectId END) AS projectCnt,
                    NVL(SUM(CASE WHEN p.STATUS='PAID' THEN p.AMOUNT END),0) AS revenue
                FROM months m
                LEFT JOIN PAYMENT p
                    ON p.createdAt >= m.m
                    <![CDATA[
                        AND p.createdAt <  ADD_MONTHS(m.m,1)
                    ]]>
                LEFT JOIN backingDetail bd ON bd.backingId = p.backingId
                LEFT JOIN reward rw ON rw.rewardId = bd.rewardId
                GROUP BY m.m
                ORDER BY m.m
            </when>
            <otherwise>
                WITH bounds AS (
                    SELECT TRUNC(MIN(createdAt),'MM') AS min_m, TRUNC(NVL(MAX(createdAt),SYSDATE),'MM') AS max_m
                    FROM PAYMENT
                ),
                months AS (
                    SELECT ADD_MONTHS(b.min_m, LEVEL-1) AS m
                    FROM bounds b
                    <![CDATA[
                        CONNECT BY ADD_MONTHS(b.min_m, LEVEL-1) <= b.max_m
                    )
                    ]]>
                SELECT
                    TO_CHAR(m.m,'YYYY-MM') AS month,
                    COUNT(DISTINCT CASE WHEN p.STATUS='PAID' THEN rw.projectId END) AS projectCnt,
                    NVL(SUM(CASE WHEN p.STATUS='PAID' THEN p.AMOUNT END),0) AS revenue
                FROM months m
                LEFT JOIN PAYMENT p
                    ON p.createdAt >= m.m
                    <![CDATA[
                        AND p.createdAt <  ADD_MONTHS(m.m,1)
                    ]]>
                LEFT JOIN backingDetail bd ON bd.backingId = p.backingId
                LEFT JOIN reward rw ON rw.rewardId = bd.rewardId
                GROUP BY m.m
                ORDER BY m.m
            </otherwise>
        </choose>
    </select>

    <!-- 리워드별 판매 Top 조회 쿼리 -->
    <select id="getRewardSalesTops" parameterType="java.util.Map" resultType="rewardSalesTop">
        SELECT * FROM (
            SELECT
                r.rewardName AS rewardName,
                SUM(bd.quantity) AS qty,
                SUM(bd.quantity * bd.price) AS revenue
            FROM payment pay
            JOIN backing b ON b.backingId = pay.backingId
            JOIN backingDetail bd ON bd.backingId = b.backingId
            JOIN reward r ON r.rewardId = bd.rewardId
            WHERE pay.status = 'PAID'
            <if test="from != null and to != null">
                AND pay.createdAt >= #{from, jdbcType=TIMESTAMP}
                <![CDATA[
                    AND pay.createdAt < #{to, jdbcType=TIMESTAMP}
                ]]>
            </if>
            GROUP BY r.rewardId, r.rewardName
            <choose>
                <when test="metric == 'revenue'">ORDER BY revenue DESC, qty DESC</when>
                <otherwise>ORDER BY qty DESC, revenue DESC</otherwise>
            </choose>
            )
            <![CDATA[
                WHERE ROWNUM <= #{limit}
            ]]>
    </select>

    <!-- 결제수단별 판매 비중 조회 쿼리 -->
    <select id="getPaymentMethods" parameterType="java.util.Map" resultType="paymentMethod">
        SELECT method AS paymentMethod, COUNT(*) AS cnt
        FROM payment
        WHERE status = 'PAID'
        <if test="from != null and to != null">
            AND createdAt >= #{from,jdbcType=TIMESTAMP}
            <![CDATA[
                AND createdAt < #{to, jdbcType=TIMESTAMP}
            ]]>
        </if>
        GROUP BY method
    </select>

    <!-- 카테고리별 성공/실패 건수 조회 쿼리 -->
    <select id="getCategorySuccessByCategory" parameterType="java.lang.Long" resultType="categorySuccess">
        SELECT
            sc.subctgrName AS categoryName,
            SUM(CASE WHEN p.projectStatus IN ('SUCCESS','SETTLED') THEN 1 ELSE 0 END) AS successCnt,
            SUM(CASE WHEN p.projectStatus = 'FAILED' THEN 1 ELSE 0 END) AS failCnt
        FROM subcategory sc
        LEFT JOIN project p
            ON p.subctgrId = sc.subctgrId
        WHERE sc.ctgrId = #{ctgrId}
        GROUP BY sc.subctgrName
        ORDER BY sc.subctgrName
    </select>

    <sql id="projectListWhere">
        <where>
            <if test="dto.projectStatus != null and dto.projectStatus != ''">
                p.PROJECTSTATUS = #{dto.projectStatus}
            </if>
            <if test="dto.fromDate != null">
                AND p.UPDATEDAT <![CDATA[ >= ]]> #{dto.fromDate}
            </if>
            <if test="dto.toDate != null">
                AND p.UPDATEDAT <![CDATA[ < ]]> #{dto.toDateEndExclusive}
            </if>
        </where>
    </sql>

    <select id="countProject" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        <include refid="projectListWhere" />
    </select>

    <select id="getProjectList" resultType="adminProjectListDto">
        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID AS projectId,
                    p.TITLE AS title,
                    c.CREATORNAME AS creatorName,
                    p.PROJECTSTATUS AS projectStatus,
                    p.STARTDATE AS startDate,
                    p.ENDDATE AS endDate,
                    p.GOALAMOUNT AS goalAmount,
                    p.CURRAMOUNT AS currAmount,
                    p.BACKERCNT AS backerCnt,
                    p.UPDATEDAT AS updatedAt,
                    cg.CTGRNAME AS ctgrName,
                    sc.SUBCTGRNAME AS subctgrName
                FROM PROJECT p
                JOIN CREATOR c ON c.CREATORID = p.CREATORID
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
                <include refid="projectListWhere" />
                ORDER BY p.UPDATEDAT DESC, p.PROJECTID DESC
            ) T
            WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
        )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <update id="cancelProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'CANCELED'
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS <![CDATA[ <> ]]> 'CANCELED'
    </update>

    <update id="updateProject">
        UPDATE PROJECT
        <set>
            <if test="subctgrId != null"> SUBCTGRID = #{subctgrId}, </if>
            <if test="title != null"> TITLE = #{title}, </if>
            <if test="thumbnail != null"> THUMBNAIL = #{thumbnail}, </if>
            <if test="projectStatus != null"> PROJECTSTATUS = #{projectStatus} </if>
        </set>
        WHERE PROJECTID = #{projectId}
    </update>
    
    <sql id="verifyFilterWhere">
        <where>
            p.PROJECTSTATUS = 'VERIFYING'
            AND p.ISVERIFIED = 'Y'
            <if test="dto.fromDate != null">
                AND p.REQUESTEDAT <![CDATA[ >= ]]> #{dto.fromDate}
            </if>
            <if test="dto.toDate != null">
                AND p.REQUESTEDAT <![CDATA[ < ]]> #{dto.toDateEndExclusive}
            </if>
        </where>
    </sql>
    
    <select id="countProjectVerify" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        <include refid="verifyFilterWhere" />
    </select>

    <select id="getProjectVerifyList" resultType="projectVerifyListDto">
        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID AS projectId,
                    p.TITLE AS title,
                    c.CREATORNAME AS creatorName,
                    cg.CTGRID AS ctgrId,
                    cg.CTGRNAME AS ctgrName,
                    sc.SUBCTGRID AS subctgrId,
                    sc.SUBCTGRNAME AS subctgrName,
                    p.GOALAMOUNT AS goalAmount,
                    p.STARTDATE AS startDate,
                    p.ENDDATE AS endDate,
                    p.PROJECTSTATUS AS projectStatus,
                    p.REQUESTEDAT AS requestedAt
                FROM PROJECT p
                JOIN CREATOR c ON c.CREATORID = p.CREATORID
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
                <include refid="verifyFilterWhere" />
                ORDER BY p.REQUESTEDAT
                ) T
            WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
            )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="getProjectVerifyDetail" resultType="projectVerifyDetailDto">
        SELECT *
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        WHERE p.PROJECTID = #{projectId}
    </select>

    <update id="approveProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'UPCOMING',
            ISVERIFIED = 'N'
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS = 'VERIFYING'
          AND ISVERIFIED = 'Y'
    </update>

    <update id="rejectProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'REJECTED',
            ISVERIFIED = 'N',
            REJECTEDREASON = #{rejectedReason}
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS = 'VERIFYING'
          AND ISVERIFIED = 'Y'
    </update>

    <select id="userTotal" resultType="Integer">
        SELECT COUNT(*) FROM users
    </select>

    <select id="userList" resultType="user">
        SELECT * FROM
        (SELECT sub.*, ROWNUM rnum FROM (
        SELECT * FROM users order by USERID desc
        ) sub WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow})
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="userDetail" resultType="user">
        SELECT * FROM user
        WHERE USERID = #{userId}
    </select>

    <update id="updateUser" parameterType="com.example.funding.dto.request.cs.UserAdminUpdateRequestDto">
        UPDATE user
        SET USERID = #{userId},
        NICKNAME = #{nickname},
        ISSUSPENDED = #{isSuspended},
        REASON = #{reason},
        SUSPENDEDAT = SYSDATE,
        RELEASEDAT = SYSDATE,
        WHERE USERID=#{userId}
    </update>

</mapper>