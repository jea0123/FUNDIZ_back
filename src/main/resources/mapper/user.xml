<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.UserMapper">

    <insert id="signUp" parameterType="user">
        INSERT INTO USERS (USERID, EMAIL, PWD, NICKNAME)
        VALUES
        (USERS_SEQ.NEXTVAL, #{email}, #{password}, #{nickname})
    </insert>

    <select id="getUserById" resultType="user">
        SELECT * FROM USERS
        WHERE USERID = #{userId}
    </select>
    
    <update id="updateLastLogin" parameterType="Long">
        UPDATE USERS
        SET LASTLOGINAT = SYSDATE
        WHERE USERID = #{userId}
    </update>

    <select id="findByEmail" parameterType="String" resultType="user">
        SELECT * FROM USERS WHERE EMAIL = #{email}
    </select>

    <select id="findByNickname" parameterType="String" resultType="user">
        SELECT * FROM USERS WHERE NICKNAME = #{nickname}
    </select>

    <select id="getRecentViewProjects" resultType="recentViewProject">
        SELECT *
        FROM (
            SELECT
            pr.projectId,
            NVL2(TRIM(c.creatorName), c.creatorName, 'Unknown Creator') AS creatorName,
            pr.Title,
            pr.Thumbnail,
            CASE WHEN NVL(pr.goalAmount,0) > 0
                THEN ROUND(NVL(pr.currAmount,0) / NULLIF(pr.goalAmount,0) * 100)
                ELSE 0 END AS percentNow,
            pr.currAmount,
            pr.endDate,
            rv.viewedAt
        FROM recentview rv
        JOIN project pr ON rv.projectId = pr.projectId
        JOIN creator c ON pr.creatorId = c.creatorId
        WHERE rv.userId = #{userId}
        ORDER BY rv.viewedAt DESC
        )
        <![CDATA[
            WHERE ROWNUM <= 10
        ]]>
    </select>

</mapper>