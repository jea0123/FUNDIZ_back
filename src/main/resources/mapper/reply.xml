<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.ReplyMapper">

    <select id="getReplyListById" resultType="reply">
        SELECT * FROM REPLY
        WHERE CMID = #{cmId}
        AND TRIM(CODE) = #{code}
    </select>

    <select id="getReplyList" resultType="replyDto">
        SELECT *
        FROM (
            SELECT
                r.REPLYID,
                r.CMID,
                r.USERID,
                r.CONTENT,
                r.ISSECRET,
                r.CREATEDAT,
                u.NICKNAME,
                u.PROFILEIMG
            FROM REPLY r
            LEFT JOIN USERS u ON u.USERID = r.USERID
            WHERE r.CMID = #{cmId}
            AND r.CODE = 'CM'
            <if test="lastCreatedAt != null">
                <![CDATA[
                    AND (
                        r.CREATEDAT < #{lastCreatedAt}
                        OR (r.CREATEDAT = #{lastCreatedAt} AND r.REPLYID < #{lastId})
                    )
                ]]>
            </if>
            ORDER BY r.CREATEDAT DESC, r.REPLYID DESC
        )
        WHERE ROWNUM <![CDATA[ <= ]]> #{size}
    </select>

    <insert id="createCommunityReply">
        <selectKey keyProperty="replyId" resultType="Long" order="BEFORE">
            SELECT REPLY_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO REPLY (REPLYID, CMID, USERID, CONTENT, ISSECRET, CODE)
        VALUES (#{replyId}, #{cmId}, #{userId}, #{content}, #{isSecret}, #{code})
    </insert>

    <select id="getInquiryReplyList" resultType="inquiryReplyDto">
        SELECT *
        FROM (
        SELECT
        REPLYID,
        INQID,
        CONTENT,
        CREATEDAT
        FROM REPLY
        WHERE INQID = #{inqId}
        AND CODE = 'IQ'
        <if test="lastCreatedAt != null">
            <![CDATA[
                AND (
                    CREATEDAT < #{lastCreatedAt}
                    OR (CREATEDAT = #{lastCreatedAt} AND REPLYID < #{lastId})
                )
            ]]>
        </if>
        ORDER BY CREATEDAT DESC, REPLYID DESC
        )
        WHERE ROWNUM <![CDATA[ <= ]]> #{size}
    </select>

    <select id="getQnaReplyList" resultType="qnaReplyDto">
        SELECT *
        FROM (
        SELECT
        REPLYID,
        QNAID,
        CONTENT,
        CREATEDAT
        FROM REPLY
        WHERE QNAID = #{qnaId}
        AND CODE = 'QnA'
        <if test="lastCreatedAt != null">
            <![CDATA[
                AND (
                    CREATEDAT < #{lastCreatedAt}
                    OR (CREATEDAT = #{lastCreatedAt} AND REPLYID < #{lastId})
                )
            ]]>
        </if>
        ORDER BY CREATEDAT DESC, REPLYID DESC
        )
        WHERE ROWNUM <![CDATA[ <= ]]> #{size}
    </select>

    <insert id="createInquiryReply">
        <selectKey keyProperty="replyId" resultType="Long" order="BEFORE">
            SELECT REPLY_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO REPLY (REPLYID, INQID, CONTENT, CODE)
        VALUES (#{replyId}, #{inqId}, #{content}, #{code})
    </insert>

    <insert id="createQnaReply">
        <selectKey keyProperty="replyId" resultType="Long" order="BEFORE">
            SELECT REPLY_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO REPLY (REPLYID, QNAID, CONTENT, CODE, CREATORID)
        VALUES (#{replyId}, #{qnaId}, #{content}, #{code}, #{creatorId})
    </insert>
</mapper>
