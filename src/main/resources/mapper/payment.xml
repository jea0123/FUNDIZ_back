<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.PaymentMapper">

    <select id="findRecentSuccessful" resultType="payment">
        SELECT paymentid, backingid, orderid, method, status, amount, cardcompany, createdat
        FROM PAYMENT
        WHERE STATUS IN ('PAID')
        AND CREATEDAT >= #{since}
    </select>

    <select id="backingPagePayment" resultType="com.example.funding.dto.response.payment.BackingPagePaymentDto">
        select
        p.orderId,
        p.method,
        p.amount,
        p.cardCompany
        From PaymentInfo pI
        JOIN backing b ON b.backingId = p.backingId
        JOIN users u ON u.userId = b.userId
        WHERE u.userId = #{userId}
    </select>

    <insert id="addPayment" parameterType="com.example.funding.model.Payment">
        <selectKey keyProperty="paymentId" resultType="long" order="BEFORE">
            SELECT PAYMENT_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO payment (
        paymentId,
        backingId,
        orderId,
        method,
        amount,
        status,
        cardCompany
        ) VALUES (
        #{paymentId},
        #{backingId},
        #{orderId},
        #{method},
        #{amount},
        #{status},
        #{cardCompany}
        )
    </insert>

    <select id="findUserMethod" resultType="com.example.funding.model.Payment">
        SELECT *
        FROM (
        SELECT p.paymentid, p.backingid, p.orderid, p.method, p.status, p.amount, p.cardcompany, p.createdat

        FROM payment p
        JOIN backing b ON p.backingId = b.backingId
        WHERE b.userId = #{userId}
        AND UPPER(TRIM(p.method)) = UPPER(TRIM(#{method}))
        AND UPPER(TRIM(p.cardCompany)) = UPPER(TRIM(#{cardCompany}))
        ORDER BY p.paymentId DESC
        )
        WHERE ROWNUM = 1
    </select>

    <select id="findUserPayment" parameterType="map" resultType="com.example.funding.model.Payment">
        SELECT paymentid, backingid, orderid, method, status, amount, cardcompany, createdat
        FROM payment
        WHERE userId = #{userId}
        AND method = #{method}
        AND cardCompany = #{cardCompany}
        FETCH FIRST 1 ROWS ONLY
    </select>

    <update id="updateBackingPayment" parameterType="com.example.funding.model.Payment">
        UPDATE payment
        SET backingId = #{backingId},
        amount = #{amount},
        status = #{status}
        WHERE paymentId = #{paymentId}
    </update>

    <insert id="addCard" parameterType="com.example.funding.dto.request.payment.AddCardDto">
        <selectKey keyProperty="payInfoId" resultType="long" order="BEFORE">
            SELECT PAYMENT_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO paymentInfo (
        payInfoId,
        userId,
        cardCompany,
        method,
        cardNum
        ) VALUES (
        #{payInfoId},
        #{userId},
        #{cardCompany},
        #{method},
        #{cardNum}
        )
    </insert>

    <select id = "getCardList" resultType="com.example.funding.dto.response.payment.CardListDto">
        select
            payInfoId,
            cardCompany,
            method,
            cardNum
        from
            paymentInfo
        WHERE
            userId = #{userId}
    </select>

    <delete id="deleteCard" parameterType="long">
        DELETE FROM paymentInfo
        where payInfoId = #{payInfoId}
    </delete>

    <select id="getPaymentInfo" parameterType="long" resultType="com.example.funding.model.PaymentInfo">
        SELECT
        payInfoId,
        cardCompany,
        method,
        cardNum
        FROM PaymentInfo
        WHERE
        userId = #{userId}
    </select>
</mapper>