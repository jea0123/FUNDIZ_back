<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.ProjectMapper">

    <update id="updateViewCnt">
        UPDATE PROJECT
        SET VIEWCNT = VIEWCNT + 1
        WHERE PROJECTID = #{projectId}
    </update>

    <select id="findById" resultType="project">
        SELECT
        projectId, creatorId, subctgrId, title, goalAmount, currAmount, startDate, endDate, content, contentBlocks,
        thumbnail, businessDoc, TRUNC(createdAt), TRUNC(updatedat), projectStatus, backerCnt, likeCnt, viewCnt,
        requestedAt, rejectedReason
        FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </select>

    <select id="findByIds" resultType="project">
        SELECT projectId, creatorId, subctgrId, title, goalAmount, currAmount, startDate, endDate, content, contentBlocks,
        thumbnail, businessDoc, TRUNC(createdAt), TRUNC(updatedat), projectStatus, backerCnt, likeCnt, viewCnt,
        requestedAt, rejectedReason
        FROM project
        WHERE projectId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getProjectRow" resultType="projectRow">
        SELECT
        p.PROJECTID AS projectId,
        p.CREATORID AS creatorId,
        p.SUBCTGRID AS subctgrId,
        p.TITLE AS title,
        p.GOALAMOUNT AS goalAmount,
        p.CURRAMOUNT AS currAmount,
        p.STARTDATE AS startDate,
        p.ENDDATE AS endDate,
        p.CONTENT AS content,
        p.CONTENTBLOCKS AS contentBlocks,
        p.THUMBNAIL AS thumbnail,
        p.PROJECTSTATUS AS projectStatus,
        p.BACKERCNT AS backerCnt,
        p.LIKECNT AS likeCnt,
        p.VIEWCNT AS viewCnt,
        c.CREATORNAME AS creatorName,
        c.FOLLOWERCNT AS followerCnt,
        c.PROFILEIMG AS profileImg,
        sc.SUBCTGRNAME AS subctgrName,
        cg.CTGRNAME AS ctgrName
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        WHERE p.PROJECTID = #{projectId}
    </select>

    <select id="findByIdsAndStatus" resultType="project">
        SELECT *
        FROM project
        WHERE projectId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND PROJECTSTATUS = #{status}
    </select>

    <select id="findFeaturedJoinedWithRecent" parameterType="map" resultType="featuredProjectDto">
        SELECT projectId, title, creatorId, creatorName, thumbnail, endDate, percentNow, goalAmount, currAmount, score
        FROM (
        SELECT
        pr.PROJECTID AS projectId,
        pr.CREATORID AS creatorId,
        pr.Title AS title,
        NVL2(TRIM(c.CREATORNAME), c.CREATORNAME, 'Unknown Creator') AS creatorName,
        pr.Thumbnail AS thumbnail,
        pr.ENDDATE AS endDate,

        CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
        THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
        ELSE 0
        END AS percentNow,
        NVL(pr.GOALAMOUNT,0) AS goalAmount,

        NVL(pr.CURRAMOUNT,0) AS currAmount,

        (
        (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
        THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
        ELSE 0 END) * 0.35
        + (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
        THEN (NVL(rp.recentPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
        ELSE 0 END) * 0.15
        + (NVL(pr.BACKERCNT,0) / 50.0) * 0.20
        + (NVL(pr.LIKECNT,0) / 20.0) * 0.20
        + (NVL(pr.VIEWCNT,0) / 500.0) * 0.10
        ) AS score,

        ROW_NUMBER() OVER (
        ORDER BY
        CASE
        WHEN pr.STARTDATE >= TRUNC(SYSDATE) - #{days,jdbcType=NUMERIC} THEN 1
        ELSE 2
        END ASC,
        (
        (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
        THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
        ELSE 0 END) * 0.35
        + (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
        THEN (NVL(rp.recentPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
        ELSE 0 END) * 0.15
        + (NVL(pr.BACKERCNT, 0) / 50.0) * 0.20
        + (NVL(pr.LIKECNT, 0) / 20.0) * 0.20
        + (NVL(pr.VIEWCNT, 0) / 500.0) * 0.10
        ) DESC
        ) rn
        FROM PROJECT pr
        JOIN CREATOR c ON c.CREATORID = pr.CREATORID

        LEFT JOIN (
        SELECT bp.PROJECTID,
        SUM(p.AMOUNT) AS recentPaidAmount
        FROM PAYMENT p
        JOIN BACKING b ON b.BACKINGID = p.BACKINGID
        JOIN (
        SELECT DISTINCT bd.BACKINGID, r.PROJECTID
        FROM BACKINGDETAIL bd
        JOIN REWARD r ON r.REWARDID = bd.REWARDID
        ) bp ON bp.BACKINGID = b.BACKINGID
        WHERE p.STATUS = 'PAID'
        AND p.CREATEDAT >= TRUNC(SYSDATE) - #{days,jdbcType=NUMERIC}
        GROUP BY bp.PROJECTID
        ) rp ON rp.PROJECTID = pr.PROJECTID

        WHERE pr.PROJECTSTATUS = 'OPEN'
        )
        WHERE rn <![CDATA[ <= ]]> #{limit,jdbcType=NUMERIC}
    </select>

    <select id="findRecentTopProjectsJoined" parameterType="map" resultType="recentTop10ProjectDto">
        <![CDATA[
            SELECT *
            FROM (
              SELECT
                pr.PROJECTID AS projectId,
                pr.TITLE AS title,
                pr.THUMBNAIL AS thumbnail,
                pr.CREATORID AS creatorId,
                NVL2(TRIM(c.CREATORNAME), c.CREATORNAME, 'Unknown Creator') AS creatorName,
                NVL(pr.CURRAMOUNT,0) AS currAmount,
                NVL(pr.GOALAMOUNT,0) AS goalAmount,
                pr.ENDDATE AS endDate,
                NVL(pr.LIKECNT,0) AS likeCnt,
                NVL(pr.VIEWCNT,0) AS viewCnt,

                NVL(paid.totalPaidAmount, 0) AS totalPaidAmount,
                NVL(paid.backerCnt, 0) AS backerCnt,
                paid.lastPaidAt AS lastPaidAt,

                CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                     THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                     ELSE 0 END AS percentNow,

                ( (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                        THEN (NVL(paid.totalPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0)) * 100
                        ELSE 0 END) * 0.7
                  + (NVL(pr.LIKECNT,0)  / 50.0)  * 0.2
                  + (NVL(pr.VIEWCNT,0)  / 500.0) * 0.1
                ) AS trendScore
              FROM PROJECT pr
              JOIN CREATOR c ON c.CREATORID = pr.CREATORID

              LEFT JOIN (
                SELECT
                  r.PROJECTID,
                  SUM(p.AMOUNT) AS totalPaidAmount,
                  COUNT(DISTINCT b.USERID) AS backerCnt,
                  MAX(p.CREATEDAT) AS lastPaidAt
                FROM PAYMENT p
                JOIN BACKING b ON b.BACKINGID = p.BACKINGID
                JOIN BACKINGDETAIL bd ON bd.BACKINGID = b.BACKINGID
                JOIN REWARD r ON r.REWARDID = bd.REWARDID
                WHERE p.STATUS = 'PAID'
                  AND p.CREATEDAT >= #{since}
                GROUP BY r.PROJECTID
              ) paid ON paid.PROJECTID = pr.PROJECTID

              WHERE pr.PROJECTSTATUS = 'OPEN'
                AND (
                  #{startDays,jdbcType=NUMERIC} IS NULL
                  OR pr.STARTDATE IS NULL
                  OR pr.STARTDATE >= TRUNC(SYSDATE) - #{startDays,jdbcType=NUMERIC}
                )

              ORDER BY trendScore DESC
            ) t
            WHERE ROWNUM <= #{limit,jdbcType=NUMERIC}
        ]]>
    </select>

    <select id="getProjectCnt" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="getStatus" resultType="string">
        SELECT PROJECTSTATUS
        FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </select>

    <sql id="searchFilterWhere">
        <where>
            <if test="dto.keyword != null and dto.keyword != ''">
                (
                LOWER(p.TITLE) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                OR LOWER(p.CONTENT) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                OR LOWER(c.CREATORNAME) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                OR EXISTS (
                SELECT 1
                FROM TAG t
                WHERE t.PROJECTID = p.PROJECTID
                AND LOWER(t.TAGNAME) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                )
                )
            </if>
            <if test="dto.ctgrId != null">
                AND cg.CTGRID = #{dto.ctgrId}
            </if>
            <if test="dto.subctgrId != null">
                AND sc.SUBCTGRID = #{dto.subctgrId}
            </if>
            <if test="dto.activeOnly != null and dto.activeOnly">
                AND p.ENDDATE <![CDATA[ > ]]> SYSDATE
            </if>
        </where>
    </sql>

    <select id="searchProjects" resultType="featuredProjectDto">
        SELECT *
        FROM (
        SELECT T.*, ROWNUM rnum
        FROM (
        SELECT
        p.PROJECTID AS projectId,
        p.TITLE AS title,
        c.CREATORNAME AS creatorName,
        p.THUMBNAIL AS thumbnail,
        p.ENDDATE AS endDate,
        p.CURRAMOUNT AS currAmount,

        /* 진행률(%) */
        CASE WHEN NVL(p.GOALAMOUNT,0) > 0
        THEN ROUND(NVL(p.CURRAMOUNT,0) / NULLIF(p.GOALAMOUNT,0) * 100)
        ELSE 0
        END AS percentNow,

        NVL(p.GOALAMOUNT,0) AS goalAmount
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        <include refid="searchFilterWhere"/>

        <choose>
            <when test="dto.sort == 'liked'">
                ORDER BY p.LIKECNT DESC, P.PROJECTID DESC
            </when>
            <when test="dto.sort == 'recent'">
                ORDER BY p.PROJECTID DESC
            </when>
            <when test="dto.sort == 'amount'">
                ORDER BY p.CURRAMOUNT DESC, P.PROJECTID DESC
            </when>
            <when test="dto.sort == 'deadline'">
                ORDER BY p.ENDDATE ASC, P.PROJECTID DESC
            </when>
            <when test="dto.sort == 'percent'">
                ORDER BY percentNow DESC, P.PROJECTID DESC
            </when>
            <when test="dto.sort == 'view'">
                ORDER BY p.VIEWCNT DESC, p.PROJECTID DESC
            </when>
        </choose>
        ) T
        WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
        )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="countSearchProjects" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        <include refid="searchFilterWhere"/>
    </select>

    <select id="getProjectToOpen" resultType="map">
        SELECT *
        FROM PROJECT
        WHERE PROJECTSTATUS = 'UPCOMING'
        AND STARTDATE <![CDATA[ <= ]]> TRUNC(SYSDATE)
    </select>

    <update id="updateProjectsToOpen">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'OPEN',
        UPDATEDAT = SYSDATE
        WHERE PROJECTSTATUS = 'UPCOMING'
        AND STARTDATE <![CDATA[ <= ]]> TRUNC(SYSDATE)
    </update>

    <select id="getProjectToSuccess" resultType="map">
        SELECT *
        FROM PROJECT
        WHERE PROJECTSTATUS = 'OPEN'
        AND ENDDATE <![CDATA[ < ]]> TRUNC(SYSDATE)
        AND CURRAMOUNT <![CDATA[ >= ]]> GOALAMOUNT
    </select>

    <update id="updateProjectsToSuccess">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'SUCCESS',
        UPDATEDAT = SYSDATE
        WHERE PROJECTSTATUS = 'OPEN'
        AND ENDDATE <![CDATA[ < ]]> TRUNC(SYSDATE)
        AND CURRAMOUNT <![CDATA[ >= ]]> GOALAMOUNT
    </update>

    <select id="getProjectToFailed" resultType="map">
        SELECT *
        FROM PROJECT
        WHERE PROJECTSTATUS = 'OPEN'
        AND ENDDATE <![CDATA[ < ]]> TRUNC(SYSDATE)
        AND CURRAMOUNT <![CDATA[ < ]]> GOALAMOUNT
    </select>

    <update id="updateProjectsToFailed">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'FAILED',
        UPDATEDAT = SYSDATE
        WHERE PROJECTSTATUS = 'OPEN'
        AND ENDDATE <![CDATA[ < ]]> TRUNC(SYSDATE)
        AND CURRAMOUNT <![CDATA[ < ]]> GOALAMOUNT
    </update>

    <select id="getProjectEndDate" resultType="java.time.LocalDateTime">
        SELECT ENDDATE
        FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </select>

    <select id="getVerifyingCnt" parameterType="long" resultType="long">
        SELECT NVL(SUM(backerCnt),0)
        FROM project
        WHERE creatorId = #{creatorId}
        AND projectStatus IN ('VERIFYING')
    </select>

    <select id="getBackingCreatorProjectList" parameterType="long"
            resultType="com.example.funding.dto.response.backing.BackingCreatorProjectListDto">
        SELECT
        projectId,
        creatorId,
        title,
        goalAmount,
        currAmount,
        thumbnail,
        backerCnt
        FROM
        project
        WHERE
        CREATORID = #{creatorId}
    </select>

    <select id="getCShippingList" parameterType="long"
            resultType="com.example.funding.dto.response.shipping.CreatorShippingProjectList">
        SELECT
        p.creatorId,
        p.projectId,
        p.title,
        p.backerCnt,
        count(case when s.shippingStatus = 'DELIVERED' THEN b.userId END) AS completedShippingCnt
        FROM project p
        JOIN creator c ON p.creatorId = c.creatorId
        JOIN reward r ON r.projectId = p.projectId
        JOIN backingDetail bd ON bd.rewardId = r.rewardId
        JOIN backing b ON b.backingId = bd.backingId
        JOIN users u ON u.userId = b.userId
        JOIN shipping s ON b.backingId = s.backingId
        where c.creatorId = #{creatorId}
        AND (p.projectStatus = 'OPEN' OR p.projectStatus = 'UPCOMING')
        AND b.backingStatus = 'COMPLETED' OR b.backingStatus =  'PENDING'
        group by p.projectId, p.creatorId, p.title, p.backerCnt
    </select>

    <update id="updateProjectSettled">
        UPDATE project
        SET projectStatus = #{status},
        updatedAt = SYSDATE
        WHERE projectId = #{projectId}
        AND projectStatus IN ('SUCCESS', 'SETTLED')
        AND (ENDDATE + 1) <![CDATA[ < ]]> TRUNC(SYSDATE)
    </update>

    <update id="increaseLikeCnt" parameterType="long">
        UPDATE project
        SET likeCnt = likeCnt + 1
        WHERE projectId = #{projectId}
    </update>

    <update id="decreaseLikeCnt" parameterType="long">
        UPDATE project
        SET likeCnt = CASE WHEN likeCnt > 0 THEN likeCnt - 1 ELSE 0 END
        WHERE projectId = #{projectId}
    </update>

    <select id="getLikeCnt" resultType="long" parameterType="long">
        SELECT likeCnt
        FROM project
        WHERE projectId = #{projectId}
    </select>

    <update id="increaseProjectCurrAmount" parameterType="map">
        update project
        set currAmount = NVL(currAmount, 0) + #{amount},
        backerCnt = NVL(backerCnt, 0) + 1
        WHERE projectId = #{projectId}
    </update>

    <update id="decreaseProjectCurrAmount">
        UPDATE project
        SET currAmount = CASE
        WHEN currAmount >= #{amount} THEN NVL(currAmount, 0) - #{amount}
        ELSE 0
        END,
        backerCnt = CASE
        WHEN backerCnt > 0 THEN backerCnt - 1
        ELSE 0
        END
        WHERE projectId = #{projectId}
    </update>

    <update id="updateProjectStatusGoal" parameterType="long">
        update project
        set projectStatus = 'SUCCESS'
        where projectId = #{projectId}
        and projectStatus = 'OPEN'
        AND (
        currAmount >= goalAmount
        OR endDate &lt; SYSDATE
        )
    </update>

    <update id="updateProjectStatusBelowGoal" parameterType="long">
        UPDATE project
        SET projectStatus = 'OPEN'
        WHERE projectId = #{projectId}
        AND currAmount &lt; goalAmount
        AND projectStatus = 'SUCCESS'
    </update>

    <select id="selectProjectsByIds" parameterType="list"
            resultType="com.example.funding.dto.response.creator.ReviewListDto$ProjectInfo">
        SELECT
        p.projectId AS projectId,
        p.title AS title,
        p.thumbnail AS thumbnail
        FROM project p
        WHERE p.projectId IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>
</mapper>
