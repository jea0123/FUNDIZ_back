<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.CommunityMapper">

    <!-- 커뮤니티 목록 조회 -->
    <select id="getCommunityList" resultType="communityDto">
        WITH base AS (
            SELECT CMID, USERID, CMCONTENT, CREATEDAT, CODE
            FROM COMMUNITY
            WHERE PROJECTID = #{projectId}
            AND TRIM(CODE) = #{code}
            <if test="lastCreatedAt != null">
                <![CDATA[
                    AND (
                        CREATEDAT < #{lastCreatedAt}
                        OR (CREATEDAT = #{lastCreatedAt} AND CMID < #{lastId})
                    )
                ]]>
            </if>
        ),
        topn AS (
            SELECT /*+ MATERIALIZE */ *
            FROM base
            WHERE ROWNUM <![CDATA[ <= ]]> #{size}
        ),
        replyCnt AS (
            SELECT /*+ MATERIALIZE */ CMID, COUNT(*) AS replyCnt
            FROM REPLY
            WHERE CMID IN (SELECT CMID FROM topn)
            GROUP BY CMID
        )
        SELECT
            t.CMID AS cmId,
            t.CMCONTENT AS cmContent,
            t.CREATEDAT AS createdAt,
            t.CODE AS code,
            u.NICKNAME AS nickname,
            u.PROFILEIMG AS profileImg,
            NVL(r.REPLYCNT, 0) AS replyCnt
        FROM topn t
        LEFT JOIN USERS u ON u.USERID = t.USERID
        LEFT JOIN REPLYCNT r ON r.CMID = t.CMID
        ORDER BY t.CREATEDAT DESC, t.CMID DESC
    </select>

    <!-- 후기 목록 조회 -->
    <select id="getReviewList" resultType="reviewDto">
        WITH base AS (
            SELECT
                CMID, USERID, CMCONTENT, NVL(RATING, 0) AS rating, CREATEDAT, CODE
            FROM COMMUNITY
            WHERE PROJECTID = #{projectId}
            AND TRIM(CODE) = #{code}
            <if test="lastCreatedAt != null">
                <![CDATA[
                    AND (
                        CREATEDAT < #{lastCreatedAt}
                        OR (CREATEDAT = #{lastCreatedAt} AND CMID < #{lastId})
                    )
                ]]>
            </if>
        ),
        topn AS (
            SELECT /*+ MATERIALIZE */
                *
            FROM base
            WHERE ROWNUM <![CDATA[ <= ]]> #{size}
        ),
        REPLYCNT AS (
            SELECT /*+ MATERIALIZE */
                CMID, COUNT(*) AS replyCnt
            FROM REPLY
            WHERE CMID IN (SELECT CMID FROM topn)
            GROUP BY CMID
        )
        SELECT
            t.CMID        AS cmId,
            t.CMCONTENT   AS cmContent,
            t.CREATEDAT   AS createdAt,
            t.CODE        AS code,
            t.RATING      AS rating,
            u.NICKNAME    AS nickname,
            u.PROFILEIMG  AS profileImg,
            NVL(r.REPLYCNT, 0) AS replyCnt
        FROM topn t
        LEFT JOIN USERS u     ON u.USERID = t.USERID
        LEFT JOIN REPLYCNT r ON r.CMID   = t.CMID
        ORDER BY t.CREATEDAT DESC, t.CMID DESC
    </select>

    <insert id="createCommunity">
        <selectKey keyProperty="cmId" resultType="Long" order="BEFORE">
            SELECT COMMUNITY_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO COMMUNITY (CMID, USERID, PROJECTID, CMCONTENT, CODE)
        VALUES (#{cmId}, #{userId}, #{projectId}, #{cmContent}, 'CM')
    </insert>

    <select id="existsCommunityById" resultType="int">
        SELECT COUNT(*) FROM COMMUNITY
        WHERE CMID = #{cmId}
    </select>

    <select id="getCommunityById" resultType="community">
        SELECT *
        FROM COMMUNITY
        WHERE CMID = #{cmId}
    </select>

    <select id="findCreatorCommunityIds" resultType="long" parameterType="map">
        SELECT cm.cmId
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}
        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>
        <if test="lastCreatedAt != null and lastId != null">
            AND (
            cm.createdAt &lt; #{lastCreatedAt, jdbcType=TIMESTAMP}
            OR (cm.createdAt = #{lastCreatedAt, jdbcType=TIMESTAMP} AND cm.cmId &lt; #{lastId})
            )
        </if>
        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>
        ORDER BY cm.createdAt DESC, cm.cmId DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <select id="findCreatorCommunityWindow" parameterType="map"
            resultType="com.example.funding.dto.response.creator.ReviewListDto$Review">
        SELECT *
        FROM (
        SELECT
        cm.cmId AS cmId,
        cm.userId AS userId,
        cm.projectId AS projectId,
        cm.cmContent AS cmContent,
        cm.createdAt AS createdAt
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}

        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>

        <if test="lastCreatedAt != null and lastId != null">
            AND (
            cm.createdAt &lt; #{lastCreatedAt, jdbcType=TIMESTAMP}
            OR (cm.createdAt = #{lastCreatedAt, jdbcType=TIMESTAMP}
            AND cm.cmId &lt; #{lastId})
            )
        </if>

        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>

        ORDER BY cm.createdAt DESC, cm.cmId DESC
        )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <select id="selectReviewImagesByCmIds" parameterType="list"
            resultType="com.example.funding.dto.response.creator.ReviewListDto$Image">
        SELECT
        a.cmId AS cmId,
        a.filePath AS url
        FROM attach a
        WHERE a.code = 'CM'
        AND a.cmId IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY a.cmId, a.attachId
    </select>

    <select id="countByProjectGrouped" resultType="countsAgg">
        SELECT
        NVL((
        SELECT SUM(CASE WHEN c.CODE = 'CM' THEN 1 ELSE 0 END)
        FROM COMMUNITY c
        WHERE c.PROJECTID = #{projectId}
        ), 0) AS communityTotal,
        NVL((
        SELECT SUM(CASE WHEN c.CODE = 'RV' THEN 1 ELSE 0 END)
        FROM COMMUNITY c
        WHERE c.PROJECTID = #{projectId}
        ), 0) AS reviewTotal
        FROM dual
    </select>

    <select id="countCreatorCommunity" resultType="long" parameterType="map">
        SELECT COUNT(*)
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}
        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>
        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>
    </select>
</mapper>
