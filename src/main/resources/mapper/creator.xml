<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.CreatorMapper">

    <insert id="insertCreator" parameterType="creator">
        INSERT INTO CREATOR (
            CREATORID, USERID, CREATORNAME, CREATORTYPE, FOLLOWERCNT, BUSINESSNUM, PROFILEIMG, EMAIL, PHONE, ACCOUNT, BANK
        ) VALUES (
            CREATOR_SEQ.NEXTVAL, #{userId}, #{creatorName}, #{creatorType}, 0, #{businessNum}, #{profileImg}, #{email}, #{phone}, #{account}, #{bank}
        )
    </insert>

    <select id="findByIds" resultType="creator">
        SELECT *
        FROM creator
        WHERE creatorId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="findById" parameterType="Long" resultType="creator">
        SELECT *
        FROM creator
        WHERE creatorId = #{creatorId}
    </select>

    <!--    <select id="">-->
    <!--        SELECT-->
    <!--            (-->
    <!--            SELECT count(*)-->
    <!--            FROM project-->
    <!--            WHERE creatorId = #{creatorId}-->
    <!--            ) AS totalProject,-->

    <!--            (-->
    <!--            SELECT sum(s.*)-->
    <!--            FROM settlement s-->
    <!--            JOIN project p ON p.projectId = s.projectId-->
    <!--            JOIN creator c ON c.creatorId = p.creatorId-->
    <!--            WHERE creatorId = #{creatorId}-->
    <!--            ) AS totalAmount,-->

    <!--            (-->
    <!--            SELECT count(b.backingId)-->
    <!--            FROM backing b-->
    <!--            JOIN backingDetail bd ON b.backingId = bd.backingId-->
    <!--            JOIN reward r ON bd.rewardId = r.rewardId-->
    <!--            JOIN project p ON r.projectId = p.projectId-->
    <!--            WHERE p.creatorId = #{creatorId}-->
    <!--            ) AS totalBackers,-->

    <!--            (-->
    <!--            select count(*)-->
    <!--            from project p-->
    <!--            where p.creatorId = 96-->
    <!--            and p.projectStatus ='VERIFYING';-->
    <!--            ) AS pendingApproval-->
    <!--        FROM dual;-->

    <!--    </select>-->



    <sql id="projectListWhere">
        <where>
            p.CREATORID = #{creatorId}
            <if test="dto.projectStatus != null and dto.projectStatus != ''">
                AND p.PROJECTSTATUS = #{dto.projectStatus}
            </if>
            <if test="dto.fromDate != null">
                AND p.UPDATEDAT <![CDATA[ >= ]]> #{dto.fromDate}
            </if>
            <if test="dto.toDate != null">
                AND p.UPDATEDAT <![CDATA[ < ]]> #{dto.toDateEndExclusive}
            </if>
        </where>
    </sql>

    <select id="countProject" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        <include refid="projectListWhere" />
    </select>

    <select id="getProjectList" resultType="creatorProjectListDto">
        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID,
                    p.TITLE,
                    p.PROJECTSTATUS,
                    p.STARTDATE,
                    p.ENDDATE,
                    p.GOALAMOUNT,
                    p.CURRAMOUNT,
                    p.BACKERCNT,
                    cg.CTGRNAME,
                    sc.SUBCTGRNAME,

                    <!-- 심사요청일(VERIFYING) -->
                    CASE WHEN p.PROJECTSTATUS = 'VERIFYING'
                        THEN p.REQUESTEDAT
                        ELSE NULL
                    END AS requestedAt,

                    <!-- 새소식 집계: 개수/최근 작성일 -->
                    NVL(n.newsCount, 0) AS newsCount,
                    n.lastNewsAt,

                    <!-- 후기 집계: 총 후기 수, 미답글 수, 최근 작성일 -->
                    NVL(rv.reviewNewCount, 0) AS reviewNewCount,
                    NVL(rv.reviewPendingCount, 0) AS reviewPendingCount,
                    rv.lastReviewAt

                FROM PROJECT p
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID

                <!-- 새소식 집계 -->
                LEFT JOIN (
                    SELECT
                        PROJECTID,
                        COUNT(*) AS newsCount,
                        MAX(TRUNC(CREATEDAT)) AS lastNewsAt
                    FROM NEWS
                    GROUP BY PROJECTID
                ) n ON n.PROJECTID = p.PROJECTID

                <!-- 후기 집계: COMMUNITY(code='RV') + REPLY(code='RV') -->
                LEFT JOIN (
                    SELECT
                        r.PROJECTID,
                        COUNT(*) AS reviewNewCount,

                        <!-- reply가 전혀 없는 후기만 1로 집계 -->
                        SUM(CASE WHEN rp.CMID IS NULL THEN 1 ELSE 0 END) AS reviewPendingCount,

                        MAX(TRUNC(r.CREATEDAT)) AS lastReviewAt
                    FROM COMMUNITY r

                    <!-- 후기 글만 -->
                    LEFT JOIN (
                        SELECT CMID
                        FROM REPLY
                        WHERE CODE = 'RV'
                        GROUP BY CMID
                    ) rp ON rp.CMID = r.CMID
                    WHERE r.CODE = 'RV'
                    GROUP BY r.PROJECTID
                ) rv ON rv.PROJECTID = p.PROJECTID
                <include refid="projectListWhere" />
                ORDER BY p.PROJECTID DESC
            ) T
            WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
        )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="getProjectDetail" resultType="creatorProjectDetailDto">
        SELECT p.*, c.*, sc.*, cg.*
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        WHERE p.PROJECTID = #{projectId}
        AND p.CREATORID = #{creatorId}
    </select>

    <insert id="saveProject">
        <selectKey keyProperty="projectId" resultType="Long" order="BEFORE">
            SELECT PROJECT_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO PROJECT (
            PROJECTID, CREATORID, SUBCTGRID, TITLE, GOALAMOUNT,
            STARTDATE, ENDDATE, CONTENT, THUMBNAIL, ISPOSTING
        ) VALUES (
            #{projectId}, #{creatorId}, #{subctgrId}, #{title}, #{goalAmount},
            #{startDate}, #{endDate}, #{content}, #{thumbnailUrl}, #{isPosting}
        )
    </insert>

    <update id="updateProject">
        UPDATE PROJECT
        <set>
            <if test="project.subctgrId != null"> SUBCTGRID = #{project.subctgrId}, </if>
            <if test="project.title != null"> TITLE = #{project.title}, </if>
            <if test="project.content != null"> CONTENT = #{project.content}, </if>
            <if test="project.thumbnail != null"> THUMBNAIL = #{project.thumbnail}, </if>
            <if test="project.goalAmount != null"> GOALAMOUNT = #{project.goalAmount}, </if>
            <if test="project.startDate != null"> STARTDATE = #{project.startDate}, </if>
            <if test="project.endDate != null"> ENDDATE = #{project.endDate}, </if>
            UPDATEDAT = SYSDATE
        </set>
        WHERE PROJECTID = #{project.projectId}
        AND CREATORID = #{creatorId}
        AND PROJECTSTATUS = 'DRAFT'
    </update>

    <delete id="deleteProject">
        DELETE FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </delete>

    <update id="markVerifyProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'VERIFYING',
            ISVERIFIED = 'Y',
            REQUESTEDAT = SYSDATE
        WHERE PROJECTID = #{projectId}
        AND PROJECTSTATUS = 'DRAFT'
        AND ISVERIFIED = 'N'
    </update>

    <select id="existsCreator" resultType="int">
        SELECT COUNT(*)
        FROM CREATOR
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="hasRequiredCreatorProfile" resultType="int">
        <![CDATA[
            SELECT CASE
                WHEN NVL(TRIM(CREATORNAME), '') <> ''
                 AND NVL(TRIM(BUSINESSNUM), '') <> ''
                 AND NVL(TRIM(EMAIL), '') <> ''
                 AND NVL(TRIM(PHONE), '') <> ''
                THEN 1 ELSE 0
                END
            FROM CREATOR
            WHERE CREATORID = #{creatorId}
        ]]>
    </select>

    <select id="getCreatorProfileSummary" resultType="creatorProfileSummaryDto">
        SELECT
            CREATORID,
            CREATORNAME,
            BUSINESSNUM,
            EMAIL,
            PHONE
        FROM CREATOR
        WHERE CREATORID = #{creatorId}
    </select>

    <select id="getQnaListOfCreator" resultType="CreatorQnaDto">
        SELECT * FROM
        (SELECT sub.*, ROWNUM rnum FROM (
        SELECT
        q.QNAID AS qnaId,
        q.PROJECTID AS projectId,
        q.USERID AS userId,
        q.CREATORID AS creatorId,
        q.CONTENT AS content,
        CAST(q.CREATEDAT AS DATE) AS createdAt,
        p.TITLE AS title
        from qna q
        join project p on q.projectid = p.projectid
        WHERE q.CREATORID = #{creatorId} order by q.QNAID desc
        ) sub  WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow})
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="qnaTotalOfCreator" resultType="Integer">
        SELECT COUNT(*) FROM qna
        WHERE CREATORID = #{creatorId}
    </select>

    <select id = "getProjectRankDate" parameterType="long" resultType="com.example.funding.dto.response.creator.CreatorDashboardRankDto">
        SELECT
            creatorId,
            title,
            backerCnt,
            likeCnt,
            viewCnt
        FROM PROJECT
        WHERE CREATORID = #{creatorId}
    </select>

    <select id ="creatorDashboardDto" parameterType="long" resultType="com.example.funding.dto.response.creator.CreatorDashboardDto">
        SELECT
            count(*) AS totalProjectCnt,
            count(CASE WHEN projectStatus = 'FAILED' THEN creatorId END) AS projectFailedCnt
        FROM
            project
        WHERE CREATORID = #{creatorId}
        GROUP BY creatorId
    </select>

</mapper>