<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.AdminMapper">

    <!-- KPI 조회 쿼리 -->
    <select id="getKpiByMonths" parameterType="java.lang.Integer" resultType="kpi">
        SELECT
            NVL(SUM(CASE WHEN STATUS='PAID' THEN AMOUNT END),0) AS totalBackingAmount,
            ROUND(NVL(SUM(CASE WHEN STATUS='PAID' THEN AMOUNT END),0) * 0.05, 0) AS fee,
            CASE WHEN COUNT(*) > 0
                THEN ROUND((COUNT(CASE WHEN STATUS='PAID' THEN 1 END)/COUNT(*))*100.0,1)
                ELSE 0 END AS successRate,
            ROUND(NVL(AVG(CASE WHEN STATUS='PAID' THEN AMOUNT END),0),0) AS backingAmountAvg
        FROM PAYMENT
        <if test="months != null and months != 0">
            WHERE createdAt >= ADD_MONTHS(TRUNC(SYSDATE,'MM'), -(#{months} - 1))
            <![CDATA[
                AND createdAt <  ADD_MONTHS(TRUNC(SYSDATE,'MM'), 1)
            ]]>
        </if>
    </select>

    <!-- 월별 트렌드 조회 쿼리 -->
    <select id="getMonthlyTrends" parameterType="java.lang.Integer" resultType="revenueTrend">
        <choose>
            <when test="months != null and months != 0">
                WITH months AS (
                    SELECT ADD_MONTHS(TRUNC(SYSDATE,'MM'), -(#{months} - LEVEL)) AS m
                    FROM dual
                    <![CDATA[
                        CONNECT BY LEVEL <= #{months}
                        )
                    ]]>
                SELECT
                    TO_CHAR(m.m,'YYYY-MM') AS month,
                    COUNT(DISTINCT CASE WHEN p.STATUS='PAID' THEN rw.projectId END) AS projectCnt,
                    NVL(SUM(CASE WHEN p.STATUS='PAID' THEN p.AMOUNT END),0) AS revenue
                FROM months m
                LEFT JOIN PAYMENT p
                    ON p.createdAt >= m.m
                    <![CDATA[
                        AND p.createdAt <  ADD_MONTHS(m.m,1)
                    ]]>
                LEFT JOIN backingDetail bd ON bd.backingId = p.backingId
                LEFT JOIN reward rw ON rw.rewardId = bd.rewardId
                GROUP BY m.m
                ORDER BY m.m
            </when>
            <otherwise>
                WITH bounds AS (
                    SELECT TRUNC(MIN(createdAt),'MM') AS min_m, TRUNC(NVL(MAX(createdAt),SYSDATE),'MM') AS max_m
                    FROM PAYMENT
                ),
                months AS (
                    SELECT ADD_MONTHS(b.min_m, LEVEL-1) AS m
                    FROM bounds b
                    <![CDATA[
                        CONNECT BY ADD_MONTHS(b.min_m, LEVEL-1) <= b.max_m
                    )
                    ]]>
                SELECT
                    TO_CHAR(m.m,'YYYY-MM') AS month,
                    COUNT(DISTINCT CASE WHEN p.STATUS='PAID' THEN rw.projectId END) AS projectCnt,
                    NVL(SUM(CASE WHEN p.STATUS='PAID' THEN p.AMOUNT END),0) AS revenue
                FROM months m
                LEFT JOIN PAYMENT p
                    ON p.createdAt >= m.m
                    <![CDATA[
                        AND p.createdAt <  ADD_MONTHS(m.m,1)
                    ]]>
                LEFT JOIN backingDetail bd ON bd.backingId = p.backingId
                LEFT JOIN reward rw ON rw.rewardId = bd.rewardId
                GROUP BY m.m
                ORDER BY m.m
            </otherwise>
        </choose>
    </select>

    <!-- 리워드별 판매 Top 조회 쿼리 -->
    <select id="getRewardSalesTops" parameterType="java.util.Map" resultType="rewardSalesTop">
        SELECT * FROM (
            SELECT
                r.rewardName AS rewardName,
                SUM(bd.quantity) AS qty,
                SUM(bd.quantity * bd.price) AS revenue
            FROM payment pay
            JOIN backing b ON b.backingId = pay.backingId
            JOIN backingDetail bd ON bd.backingId = b.backingId
            JOIN reward r ON r.rewardId = bd.rewardId
            WHERE pay.status = 'PAID'
            <if test="from != null and to != null">
                AND pay.createdAt >= #{from, jdbcType=TIMESTAMP}
                <![CDATA[
                    AND pay.createdAt < #{to, jdbcType=TIMESTAMP}
                ]]>
            </if>
            GROUP BY r.rewardId, r.rewardName
            <choose>
                <when test="metric == 'revenue'">ORDER BY revenue DESC, qty DESC</when>
                <otherwise>ORDER BY qty DESC, revenue DESC</otherwise>
            </choose>
            )
            <![CDATA[
                WHERE ROWNUM <= #{limit}
            ]]>
    </select>

    <!-- 결제수단별 판매 비중 조회 쿼리 -->
    <select id="getPaymentMethods" parameterType="java.util.Map" resultType="paymentMethod">
        SELECT method AS paymentMethod, COUNT(*) AS cnt
        FROM payment
        WHERE status = 'PAID'
        <if test="from != null and to != null">
            AND createdAt >= #{from,jdbcType=TIMESTAMP}
            <![CDATA[
                AND createdAt < #{to, jdbcType=TIMESTAMP}
            ]]>
        </if>
        GROUP BY method
    </select>

    <sql id="projectListWhere">
        <where>
            <if test="dto.projectStatus != null and dto.projectStatus.size() > 0">
                AND p.PROJECTSTATUS IN
                <foreach collection="dto.projectStatus" item="st" open="(" separator="," close=")">
                    #{st}
                </foreach>
            </if>
            <if test="dto.fromDate != null">
                AND p.UPDATEDAT <![CDATA[ >= ]]> #{dto.fromDate}
            </if>
            <if test="dto.toDate != null">
                AND p.UPDATEDAT <![CDATA[ < ]]> #{dto.toDateEndExclusive}
            </if>
        </where>
    </sql>

    <select id="countProject" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        <include refid="projectListWhere" />
    </select>

    <select id="getProjectList" resultType="adminProjectListDto">
        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID,
                    p.TITLE,
                    p.GOALAMOUNT,
                    p.CURRAMOUNT,
                    p.STARTDATE,
                    p.ENDDATE,
                    p.CREATEDAT,
                    p.UPDATEDAT,
                    p.THUMBNAIL,
                    p.PROJECTSTATUS,
                    p.BACKERCNT,
                    p.LIKECNT,
                    p.VIEWCNT,
                    sc.SUBCTGRNAME,
                    cg.CTGRNAME,
                    c.CREATORNAME
                FROM PROJECT p
                JOIN CREATOR c ON c.CREATORID = p.CREATORID
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
                <include refid="projectListWhere" />
                ORDER BY p.UPDATEDAT DESC, p.PROJECTID DESC
            ) T
            WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
        )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <update id="cancelProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'CANCELED'
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS <![CDATA[ <> ]]> 'CANCELED'
    </update>

    <update id="updateProject">
        UPDATE PROJECT
        <set>
            <if test="subctgrId != null"> SUBCTGRID = #{subctgrId}, </if>
            <if test="title != null"> TITLE = #{title}, </if>
            <if test="thumbnail != null"> THUMBNAIL = #{thumbnail}, </if>
            <if test="projectStatus != null"> PROJECTSTATUS = #{projectStatus} </if>
        </set>
        WHERE PROJECTID = #{projectId}
    </update>
    
    <sql id="verifyFilterWhere">
        <where>
            <if test="dto.projectStatus != null and dto.projectStatus.size() > 0">
                p.PROJECTSTATUS IN
                <foreach collection="dto.projectStatus" item="st" open="(" separator="," close=")">
                    #{st}
                </foreach>
            </if>
            <if test="dto.fromDate != null">
                AND p.REQUESTEDAT <![CDATA[ >= ]]> #{dto.fromDate}
            </if>
            <if test="dto.toDate != null">
                AND p.REQUESTEDAT <![CDATA[ < ]]> #{dto.toDateEndExclusive}
            </if>
        </where>
    </sql>
    
    <select id="countProjectVerify" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT p
        <include refid="verifyFilterWhere" />
    </select>

    <select id="getProjectVerifyList" resultType="projectVerifyListDto">
        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID AS projectId,
                    p.TITLE AS title,
                    c.CREATORNAME AS creatorName,
                    cg.CTGRID AS ctgrId,
                    cg.CTGRNAME AS ctgrName,
                    sc.SUBCTGRID AS subctgrId,
                    sc.SUBCTGRNAME AS subctgrName,
                    p.GOALAMOUNT AS goalAmount,
                    p.STARTDATE AS startDate,
                    p.ENDDATE AS endDate,
                    p.THUMBNAIL AS thumbnail,
                    p.PROJECTSTATUS AS projectStatus,
                    p.REQUESTEDAT AS requestedAt
                FROM PROJECT p
                JOIN CREATOR c ON c.CREATORID = p.CREATORID
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
                <include refid="verifyFilterWhere" />
                ORDER BY p.REQUESTEDAT ASC, p.PROJECTID ASC
                ) T
            WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow}
            )
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="getProjectVerifyDetail" resultType="projectVerifyDetailDto">
        SELECT
            p.PROJECTID,
            p.TITLE,
            p.GOALAMOUNT,
            p.STARTDATE,
            p.ENDDATE,
            p.CONTENT,
            p.CONTENTBLOCKS,
            p.THUMBNAIL,
            p.BUSINESSDOC,
            p.PROJECTSTATUS,
            p.REQUESTEDAT,
            sc.SUBCTGRNAME,
            cg.CTGRNAME,
            c.CREATORNAME,
            c.BUSINESSNUM,
            c.EMAIL,
            c.PHONE
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        WHERE p.PROJECTID = #{projectId}
    </select>

    <update id="approveProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'UPCOMING'
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS = 'VERIFYING'
    </update>
    
    <select id="isApprovable" resultType="int">
        SELECT COUNT(*)
        FROM PROJECT
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS = 'VERIFYING'
    </select>

    <update id="rejectProject">
        UPDATE PROJECT
        SET PROJECTSTATUS = 'REJECTED',
            REJECTEDREASON = #{rejectedReason}
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS = 'VERIFYING'
    </update>
    
    <select id="isRejectable" resultType="int">
        SELECT COUNT(*)
        FROM PROJECT
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS = 'VERIFYING'
    </select>

    <select id="userTotal" resultType="Integer">
        SELECT COUNT(*) FROM users
    </select>

    <select id="userList" resultType="user">
        SELECT * FROM
        (SELECT sub.*, ROWNUM rnum FROM (
        SELECT * FROM users order by USERID desc
        ) sub WHERE ROWNUM <![CDATA[ <= ]]> #{pager.endRow})
        WHERE rnum <![CDATA[ >= ]]> #{pager.startRow}
    </select>

    <select id="userDetail" resultType="user">
        SELECT * FROM users
        WHERE USERID = #{userId}
    </select>

    <update id="updateUser" parameterType="userAdminUpdateRequestDto">
        UPDATE users
        SET USERID = #{userId},
        NICKNAME = #{nickname},
        ISSUSPENDED = #{isSuspended},
        REASON = #{reason},
        SUSPENDEDAT = CASE
        WHEN ISSUSPENDED = 'N' AND #{isSuspended} = 'Y' THEN SYSDATE
        ELSE SUSPENDEDAT
        END,
        RELEASEDAT = CASE
        WHEN ISSUSPENDED = 'Y' AND #{isSuspended} = 'N' THEN SYSDATE
        ELSE RELEASEDAT
        END
        WHERE USERID=#{userId}
    </update>

    <insert id="registerAdmin" parameterType="registerAdminRequestDto">
        INSERT INTO ADMIN (
            ADID, ADMINID, ADMINPWD
        ) VALUES (
           ADMIN_SEQ.NEXTVAL, #{adminId}, #{adminPwd}
        )
    </insert>

    <select id="getAdminByAdminId" resultType="admin">
        SELECT * FROM ADMIN
        WHERE ADMINID = #{adminId}
    </select>

</mapper>