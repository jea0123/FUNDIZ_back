<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.SettlementMapper">

    <select id="getByProjectId" resultType="settlement">
        SELECT settlementid, projectId, creatorId, totalamount, fee, settlementAmount, settlementDate, settlementStatus, refundAmount
        FROM settlement
        WHERE projectId = #{projectId}
    </select>

    <select id="getStatus" resultType="string">
        SELECT settlementStatus
        FROM settlement
        WHERE projectId = #{projectId} AND creatorId = #{creatorId} AND settlementId = #{settlementId}
    </select>

    <update id="updateSettlementStatus" parameterType="settlementPaidRequestDto">
        UPDATE settlement
        SET settlementStatus = #{settlementStatus},
        settlementDate = SYSDATE
        WHERE projectId = #{projectId} AND creatorId = #{creatorId} AND settlementId = #{settlementId}
    </update>

    <select id="getByCreatorId" resultType="settlement">
        SELECT settlementid, projectId, creatorId, totalamount, fee, settlementAmount, settlementDate, settlementStatus, refundAmount
        FROM settlement
        WHERE creatorId = #{creatorId}
    </select>

    <select id="getSettlementSummaryByCreatorId" parameterType="long" resultType="settlementSummary">
        SELECT
        c.creatorId,
        c.creatorName,
        COALESCE(SUM(CASE WHEN s.settlementStatus = 'WAITING' THEN s.settlementAmount END), 0) AS waitingAmount,
        COALESCE(SUM(CASE WHEN s.settlementStatus = 'PAID' THEN s.settlementAmount END), 0) AS completedAmount,
        COALESCE(COUNT(CASE WHEN s.settlementStatus = 'PAID' THEN 1 END), 0) AS settledCount,
        c.bank,
        c.account
        FROM creator c
        LEFT JOIN settlement s ON c.creatorId = s.creatorId
        WHERE c.creatorId = #{creatorId}
        GROUP BY c.creatorId, c.creatorName, c.bank, c.account
    </select>

    <select id="getSettlementSummary" resultType="settlementSummary">
        SELECT
        COALESCE(SUM(CASE WHEN s.settlementStatus = 'WAITING' THEN s.settlementAmount END), 0) AS waitingAmount,
        COALESCE(SUM(CASE WHEN s.settlementStatus = 'PAID' THEN s.settlementAmount END), 0) AS completedAmount,
        COALESCE(COUNT(CASE WHEN s.settlementStatus = 'PAID' THEN 1 END), 0) AS settledCount
        FROM settlement s
    </select>

    <select id="getTotalAmountCreatorId" parameterType="long" resultType="long">
        SELECT
        NVL(SUM(totalAmount),0)
        FROM settlement
        WHERE creatorId =#{creatorId}
    </select>

    <select id="getSettlementByCreatorId" parameterType="long" resultType="creatorSettlementDto">
        SELECT
        *
        FROM settlement
        WHERE creatorId = #{creatorId}
        ORDER BY settlementDate DESC
    </select>

    <insert id="bulkInsertSettlementWaiting" parameterType="map">
        INSERT INTO settlement (
        settlementId, projectId, creatorId,
        totalAmount, fee, settlementAmount,
        settlementDate, ${statusColumn}, refundAmount
        )
        SELECT
        SETTLEMENT_SEQ.NEXTVAL,
        p.projectId,
        p.creatorId,
        NVL(paid.total_paid, 0) AS totalAmount,
        ROUND(NVL(paid.total_paid, 0) * #{feeRate,jdbcType=DOUBLE}, 0) AS fee,
        NVL(paid.total_paid, 0)
        - ROUND(NVL(paid.total_paid, 0) * #{feeRate,jdbcType=DOUBLE}, 0) AS settlementAmount,
        SYSDATE AS settlementDate,
        'WAITING' AS ${statusColumn},
        0 AS refundAmount
        FROM project p
        LEFT JOIN (
        SELECT
        r.projectId,
        SUM(pay.amount) AS total_paid
        FROM payment pay
        JOIN backing b ON b.backingId = pay.backingId
        JOIN backingDetail bd ON bd.backingId = b.backingId
        JOIN reward r ON r.rewardId = bd.rewardId
        WHERE pay.status = 'PAID'
        GROUP BY r.projectId
        ) paid
        ON paid.projectId = p.projectId
        WHERE p.endDate <![CDATA[ < ]]> TRUNC(SYSDATE)
        AND (p.currAmount >= p.goalAmount OR p.projectStatus IN ('SUCCESS'))
        AND NOT EXISTS (
        SELECT 1
        FROM settlement s
        WHERE s.projectId = p.projectId
        AND s.${statusColumn} IN ('WAITING','PAID')
        )
    </insert>

    <select id="count" resultType="int">
        SELECT COUNT(1)
        FROM (
        <include refid="BaseSelect"/>
        )
    </select>

    <select id="findPage" resultType="settlementItem">
        SELECT *
        FROM (
        SELECT t.*, ROWNUM rn
        FROM (
        <include refid="BaseSelect"/>
        ) t
        WHERE ROWNUM &lt;= #{endRow}
        )
        WHERE rn &gt;= #{startRow}
    </select>

    <sql id="BaseSelect">
        SELECT
        s.settlementId,
        s.projectId,
        p.title AS projectTitle,
        s.creatorId,
        c.creatorName AS creatorName,
        NVL(s.totalAmount, 0) AS totalAmount,
        NVL(s.fee, 0) AS fee,
        NVL(s.settlementAmount, 0) AS settlementAmount,
        NVL(s.refundAmount, 0) AS refundAmount,
        s.settlementDate,
        s.settlementStatus
        FROM settlement s
        LEFT JOIN project p ON p.projectId = s.projectId
        LEFT JOIN creator c ON c.creatorId = s.creatorId
        WHERE 1 = 1
        AND p.projectStatus IN ('SUCCESS', 'SETTLED')
        <if test="q != null and q != ''">
            AND (
            LOWER(p.title) LIKE '%' || LOWER(#{q}) || '%'
            OR LOWER(c.creatorName) LIKE '%' || LOWER(#{q}) || '%'
            )
        </if>

        <if test="status != null and status != ''">
            AND s.settlementStatus = #{status}
        </if>

        <if test="from != null">
            AND s.settlementDate &gt;= #{from}
        </if>
        <if test="to != null">
            AND s.settlementDate &lt; #{to} + 1
        </if>
        ORDER BY
<!--        NVL(s.settlementDate, DATE '1970-01-01') DESC,-->
        s.settlementId DESC
    </sql>
</mapper>