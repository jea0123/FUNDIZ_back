<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.ShippingMapper">

    <select id ="creatorShippingBackerList" parameterType = "long" resultType = "com.example.funding.dto.response.shipping.CreatorShippingBackerList">
        SELECT
            <!-- 유저 테이블 -->
            u.userId,
            u.email,
            u.nickname,

            <!-- 창작자 -->
            c.creatorId,

            <!-- 리워드 -->
            r.rewardName,

            <!-- 배송지 -->
            a.recipient,
            a.postalCode,
            a.roadAddr,
            a.detailAddr,
            a.recipientPhone,

            <!-- 배송 -->
            s.shippingStatus,
            s.trackingNum,
            s.shippedAt,
            s.deliveredAt,

            <!-- 후원상세 -->
            bd.quantity,

            <!-- 프로젝트 -->
            p.projectId,
            p.title,

            b.backingId,
            b.createdAt


        FROM project p
        JOIN creator c ON p.creatorId = c.creatorId
        JOIN reward r ON r.projectId = p.projectId
        JOIN backingDetail bd ON bd.rewardId = r.rewardId
        JOIN backing b ON b.backingId = bd.backingId
        JOIN users u ON u.userId = b.userId
        JOIN shipping s ON s.backingId = b.backingId
        JOIN address a ON s.addrId = a.addrId
        WHERE c.creatorId = #{creatorId}
        AND p.projectId = #{projectId}
    </select>

    <insert id="addShipping" parameterType="com.example.funding.model.Shipping">
        <selectKey keyProperty="shippingId" resultType="long" order="BEFORE">
            SELECT SHIPPING_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO shipping (
        shippingId,
        backingId,
        addrId,
        shippingStatus,
        trackingNum,
        shippedAt,
        deliveredAt
        ) VALUES (
        #{shippingId},
        #{backingId},
        #{addrId},
        NVL(#{shippingStatus}, 'PENDING'),
        #{trackingNum},
        #{shippedAt, jdbcType=DATE},
        #{deliveredAt, jdbcType=DATE}
        )
    </insert>


    <update id="updateShippingStatus">
        UPDATE shipping s
        <set>
            s.shippingStatus = #{shipping.shippingStatus},
            s.trackingNum = #{shipping.trackingNum}
            <choose>
                <when test="shipping.shippingStatus eq 'PENDING' or shipping.shippingStatus eq 'READY'">
                    , s.shippedAt = NULL,
                    s.deliveredAt = NULL
                </when>
                <when test="shipping.shippingStatus eq 'SHIPPED'">
                    , s.shippedAt = SYSDATE
                </when>
                <when test="shipping.shippingStatus eq 'DELIVERED'">
                    , s.deliveredAt = SYSDATE
                </when>
            </choose>
        </set>
        WHERE s.backingId = #{shipping.backingId}
        AND s.backingId IN (
        SELECT b.backingId
        FROM backing b
        JOIN backingDetail bd ON b.backingId = bd.backingId
        JOIN reward r ON r.rewardId = bd.rewardId
        JOIN project p ON p.projectId = r.projectId
        WHERE p.projectId = #{projectId}
        AND p.creatorId = #{creatorId}
        )
    </update>

    <update id = "updateBackingToShippingStatus" >
        update shipping
        set shippingStatus = 'CANCELED'
        where backingId = #{backingId}
    </update>

    <select id="findByBackingId">
        select *
        FROM Shipping
        where shippingId = #{shippingId}
    </select>
</mapper>