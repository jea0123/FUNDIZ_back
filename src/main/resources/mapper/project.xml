<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.ProjectMapper">
    <update id="updateViewCnt">
        UPDATE PROJECT
        SET VIEWCNT = VIEWCNT + 1
        WHERE PROJECTID = #{projectId}
    </update>

    <select id="getProjectById" resultType="project">
        SELECT * FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </select>

    <select id="findByIds" resultType="project">
        SELECT *
        FROM project
        WHERE projectId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="findFeatured" resultType="project">
        SELECT *
        FROM (
        SELECT *
        FROM project
        WHERE PROJECTSTATUS = 'OPEN'
        AND STARTDATE BETWEEN TRUNC(SYSDATE) - #{days}
        AND TRUNC(SYSDATE)
        )
        <![CDATA[
            WHERE ROWNUM <= #{limit, jdbcType=INTEGER}
        ]]>
    </select>

    <select id="findFeaturedExcluding" resultType="project">
        SELECT *
        FROM (
        SELECT *
        FROM project
        WHERE PROJECTSTATUS = 'OPEN'
        <if test="excludeIds != null and excludeIds.size() > 0">
            AND PROJECTID NOT IN
            <foreach collection="excludeIds" item="id" open="(" close=")" separator=",">
                #{id}
            </foreach>
        </if>
        )
        <![CDATA[
            WHERE ROWNUM <= #{limit,jdbcType=INTEGER}
        ]]>
        ORDER BY ((CURRAMOUNT / NULLIF(GOALAMOUNT,0)) * 100) * 0.5
        + (NVL(BACKERCNT,0) / 50)  * 0.2
        + (NVL(LIKECNT,0)  / 20)  * 0.2
        + (NVL(VIEWCNT,0)  / 500) * 0.1
    </select>

</mapper>
