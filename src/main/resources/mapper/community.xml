<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.CommunityMapper">

    <!-- START 커뮤니티/후기 목록 -->
<!--    <sql id="foldedQuery">-->
<!--        WITH base AS (-->
<!--            SELECT /*+ MATERIALIZE */-->
<!--                CMID, USERID, PROJECTID, CMCONTENT, NVL(RATING, 0) AS RATING, CREATEDAT, CODE-->
<!--            FROM (-->
<!--                SELECT-->
<!--                    CMID, USERID, PROJECTID, CMCONTENT, NVL(RATING, 0) AS RATING, CREATEDAT, CODE-->
<!--                FROM COMMUNITY-->
<!--                WHERE PROJECTID = #{projectId}-->
<!--                  AND TRIM(CODE) = #{code}-->
<!--                <if test="lastCreatedAt != null">-->
<!--                <![CDATA[-->
<!--                    AND (-->
<!--                        CREATEDAT < #{lastCreatedAt}-->
<!--                        OR (CREATEDAT = #{lastCreatedAt} AND CMID < #{lastId})-->
<!--                    )-->
<!--                ]]>-->
<!--                </if>-->
<!--                ORDER BY CREATEDAT DESC, CMID DESC-->
<!--            )-->
<!--            WHERE ROWNUM <![CDATA[ <= ]]> #{size}-->
<!--        )-->
<!--        SELECT-->
<!--            b.CMID AS cmId,-->
<!--            b.CMCONTENT AS cmContent,-->
<!--            b.CREATEDAT AS createdAt,-->
<!--            b.CODE AS code,-->
<!--            b.RATING AS rating,-->
<!--            u.NICKNAME AS nickname,-->
<!--            u.PROFILEIMG AS profileImg,-->

<!--            &lt;!&ndash; 댓글 총합 &ndash;&gt;-->
<!--            (-->
<!--                SELECT COUNT(*)-->
<!--                FROM REPLY r-->
<!--                WHERE r.CMID = b.CMID-->
<!--            ) AS replyCnt-->
<!--        FROM base b-->
<!--        LEFT JOIN USERS u ON u.USERID = b.USERID-->
<!--        ORDER BY b.CREATEDAT DESC, b.CMID DESC-->
<!--    </sql>-->

<!--    <select id="getCommunityList" resultType="communityDto">-->
<!--        <include refid="foldedQuery" />-->
<!--    </select>-->

<!--    <select id="getReviewList" resultType="reviewDto">-->
<!--        <include refid="foldedQuery" />-->
<!--    </select>-->
    <!-- END 커뮤니티/후기 목록 -->

    <!-- 커뮤니티 목록 -->
    <select id="getCommunityList" resultType="communityDto">
        SELECT
            c.CMID AS cmId,
            c.CMCONTENT AS cmContent,
            c.CREATEDAT AS createdAt,
            c.CODE AS code,
            u.NICKNAME AS nickname,
            u.PROFILEIMG AS profileImg,

            <!-- 댓글 총합 -->
            (
                SELECT COUNT(*)
                FROM REPLY r
                WHERE r.CMID = c.CMID
            ) AS replyCnt
        FROM (
            SELECT
                CMID, USERID, CMCONTENT, CREATEDAT, CODE
            FROM COMMUNITY
            WHERE PROJECTID = #{projectId}
            AND TRIM(CODE) = #{code}
            <if test="lastCreatedAt != null">
                <![CDATA[
                    AND (
                        CREATEDAT < #{lastCreatedAt}
                        OR (CREATEDAT = #{lastCreatedAt} AND CMID < #{lastId})
                    )
                ]]>
            </if>
            ORDER BY CREATEDAT DESC, CMID DESC
        ) c
        LEFT JOIN USERS u ON u.USERID = c.USERID
        WHERE ROWNUM <![CDATA[ <= ]]> #{size}
    </select>

    <!-- 후기 목록 -->
    <select id="getReviewList" resultType="reviewDto">
        SELECT
            c.CMID AS cmId,
            c.CMCONTENT AS cmContent,
            c.CREATEDAT AS createdAt,
            c.CODE AS code,
            NVL(c.RATING, 0) AS rating,
            u.NICKNAME AS nickname,
            u.PROFILEIMG AS profileImg,

            <!-- 댓글 총합 -->
            (
                SELECT COUNT(*)
                FROM REPLY r
                WHERE r.CMID = c.CMID
            ) AS replyCnt
        FROM (
            SELECT
                CMID, USERID, CMCONTENT, NVL(RATING, 0) AS rating, CREATEDAT, CODE
            FROM COMMUNITY
            WHERE PROJECTID = #{projectId}
            AND TRIM(CODE) = #{code}
            <if test="lastCreatedAt != null">
                <![CDATA[
                    AND (
                        CREATEDAT < #{lastCreatedAt}
                        OR (CREATEDAT = #{lastCreatedAt} AND CMID < #{lastId})
                    )
                ]]>
            </if>
            ORDER BY CREATEDAT DESC, CMID DESC
        ) c
        LEFT JOIN USERS u ON u.USERID = c.USERID
        WHERE ROWNUM <![CDATA[ <= ]]> #{size}
    </select>

    <insert id="createCommunity">
        <selectKey keyProperty="cmId" resultType="Long" order="BEFORE">
            SELECT COMMUNITY_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO COMMUNITY (CMID, USERID, PROJECTID, CMCONTENT, CODE)
        VALUES (#{cmId}, #{userId}, #{projectId}, #{cmContent}, 'CM')
    </insert>

    <select id="existsCommunityById" resultType="int">
        SELECT COUNT(*) FROM COMMUNITY
        WHERE CMID = #{cmId}
    </select>

    <select id="getCommunityById" resultType="community">
        SELECT *
        FROM COMMUNITY
        WHERE CMID = #{cmId}
    </select>

    <select id="findCreatorCommunityIds" resultType="long" parameterType="map">
        SELECT cm.cmId
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}
        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>
        <if test="lastCreatedAt != null and lastId != null">
            AND (
            cm.createdAt &lt; #{lastCreatedAt, jdbcType=TIMESTAMP}
            OR (cm.createdAt = #{lastCreatedAt, jdbcType=TIMESTAMP} AND cm.cmId &lt; #{lastId})
            )
        </if>
        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>
        ORDER BY cm.createdAt DESC, cm.cmId DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <select id="findCreatorCommunityWindow" parameterType="map"
            resultType="com.example.funding.dto.response.creator.ReviewListDto$Review">
        SELECT *
        FROM (
        SELECT
        cm.cmId AS cmId,
        cm.userId AS userId,
        cm.projectId AS projectId,
        cm.cmContent AS cmContent,
        cm.createdAt AS createdAt
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}

        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>

        <if test="lastCreatedAt != null and lastId != null">
            AND (
            cm.createdAt &lt; #{lastCreatedAt, jdbcType=TIMESTAMP}
            OR (cm.createdAt = #{lastCreatedAt, jdbcType=TIMESTAMP}
            AND cm.cmId &lt; #{lastId})
            )
        </if>

        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>

        ORDER BY cm.createdAt DESC, cm.cmId DESC
        )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <select id="selectReviewImagesByCmIds" parameterType="list"
            resultType="com.example.funding.dto.response.creator.ReviewListDto$Image">
        SELECT
        a.cmId AS cmId,
        a.filePath AS url
        FROM attach a
        WHERE a.code = 'CM'
        AND a.cmId IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY a.cmId, a.attachId
    </select>

    <select id="countByProjectGrouped" resultType="countsAgg">
        SELECT
        NVL((
        SELECT SUM(CASE WHEN c.CODE = 'CM' THEN 1 ELSE 0 END)
        FROM COMMUNITY c
        WHERE c.PROJECTID = #{projectId}
        ), 0) AS communityTotal,
        NVL((
        SELECT SUM(CASE WHEN c.CODE = 'RV' THEN 1 ELSE 0 END)
        FROM COMMUNITY c
        WHERE c.PROJECTID = #{projectId}
        ), 0) AS reviewTotal
        FROM dual
    </select>

    <select id="countCreatorCommunity" resultType="long" parameterType="map">
        SELECT COUNT(*)
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}
        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>
        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>
    </select>
</mapper>
