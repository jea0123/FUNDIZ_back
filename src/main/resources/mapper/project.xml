<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.ProjectMapper">
    <update id="updateViewCnt">
        UPDATE PROJECT
        SET VIEWCNT = VIEWCNT + 1
        WHERE PROJECTID = #{projectId}
    </update>

    <select id="getProjectById" resultType="project">
        SELECT * FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </select>

    <select id="findByIds" resultType="project">
        SELECT *
        FROM project
        WHERE projectId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="findByIdsAndStatus" resultType="project">
        SELECT *
        FROM project
        WHERE projectId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND PROJECTSTATUS = #{status}
    </select>

    <select id="findFeaturedJoinedWithRecent" parameterType="map" resultType="featuredProjectDto">
        <![CDATA[
            SELECT projectId, title, creatorName, thumbnail, endDate, percentNow, goalAmount, score
            FROM (
            SELECT
              pr.PROJECTID AS projectId,
              pr.TITLE AS title,
              NVL2(TRIM(c.CREATORNAME), c.CREATORNAME, 'Unknown Creator') AS creatorName,
              pr.THUMBNAIL AS thumbnail,
              pr.ENDDATE AS endDate,
              /* 진행률(%) */
              CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                   THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                   ELSE 0
              END AS percentNow,
              NVL(pr.GOALAMOUNT,0) AS goalAmount,

              /* 점수: 진행률 35% + 최근결제/목표 15% + 백커/좋아요/조회 */
              (
                (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                      THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                      ELSE 0 END) * 0.35
                + (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                      THEN (NVL(rp.recentPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                      ELSE 0 END) * 0.15
                + (NVL(pr.BACKERCNT,0) / 50.0)  * 0.20
                + (NVL(pr.LIKECNT,0)   / 20.0)  * 0.20
                + (NVL(pr.VIEWCNT,0)   / 500.0) * 0.10
              ) AS score,

              ROW_NUMBER() OVER (
                ORDER BY
                  CASE
                    WHEN pr.STARTDATE >= TRUNC(SYSDATE) - #{days,jdbcType=NUMERIC} THEN 1
                    ELSE 2
                  END ASC,
                  (
                    (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                          THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                          ELSE 0 END) * 0.35
                    + (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                          THEN (NVL(rp.recentPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                          ELSE 0 END) * 0.15
                    + (NVL(pr.BACKERCNT, 0) / 50.0) * 0.20
                    + (NVL(pr.LIKECNT, 0) / 20.0) * 0.20
                    + (NVL(pr.VIEWCNT, 0) / 500.0) * 0.10
                  ) DESC
              ) rn
            FROM PROJECT pr
            JOIN CREATOR c ON c.CREATORID = pr.CREATORID

            /* 최근 결제액 집계: 프로젝트별 recentPaidAmount */
            LEFT JOIN (
              SELECT bp.PROJECTID,
                     SUM(p.AMOUNT) AS recentPaidAmount
              FROM PAYMENT p
              JOIN BACKING b ON b.BACKINGID = p.BACKINGID
              JOIN (
                SELECT DISTINCT bd.BACKINGID, r.PROJECTID
                FROM BACKINGDETAIL bd
                JOIN REWARD r ON r.REWARDID = bd.REWARDID
              ) bp ON bp.BACKINGID = b.BACKINGID
              WHERE p.STATUS = 'PAID'
                AND p.CREATEDAT >= TRUNC(SYSDATE) - #{days,jdbcType=NUMERIC}
              GROUP BY bp.PROJECTID
            ) rp ON rp.PROJECTID = pr.PROJECTID

            WHERE pr.PROJECTSTATUS = 'OPEN'
          )
          WHERE rn <= #{limit,jdbcType=NUMERIC}
          ]]>
    </select>

    <select id="findRecentTopProjectsJoined" parameterType="map" resultType="recentTop10ProjectDto">
        <![CDATA[
          SELECT *
          FROM (
            SELECT
              pr.PROJECTID AS projectId,
              pr.TITLE AS title,
              pr.THUMBNAIL AS thumbnail,
              pr.CREATORID AS creatorId,
              NVL2(TRIM(c.CREATORNAME), c.CREATORNAME, 'Unknown Creator') AS creatorName,
              NVL(pr.CURRAMOUNT,0) AS currAmount,
              NVL(pr.GOALAMOUNT,0) AS goalAmount,
              pr.ENDDATE AS endDate,
              NVL(pr.LIKECNT,0) AS likeCnt,
              NVL(pr.VIEWCNT,0) AS viewCnt,

              /* 결제 기준 지표 */
              SUM(p.AMOUNT) AS totalPaidAmount,
              COUNT(DISTINCT b.USERID) AS backerCnt,
              MAX(p.CREATEDAT) AS lastPaidAt,

              /* 진행률(%) */
              CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                   THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                   ELSE 0 END AS percentNow,

              (
                (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                      THEN (SUM(p.AMOUNT) / NULLIF(pr.GOALAMOUNT,0)) * 100
                      ELSE 0 END) * 0.7
                + (NVL(pr.LIKECNT,0) / 50.0)  * 0.2
                + (NVL(pr.VIEWCNT,0) / 500.0) * 0.1
              )  AS trendScore
            FROM PAYMENT p
              JOIN BACKING b ON b.BACKINGID = p.BACKINGID
              /* BACKINGID -> PROJECTID 매핑(중복 제거) */
              JOIN (
                SELECT bd.BACKINGID, r.PROJECTID
                FROM BACKINGDETAIL bd
                JOIN REWARD r ON r.REWARDID = bd.REWARDID
                GROUP BY bd.BACKINGID, r.PROJECTID
              ) bp ON bp.BACKINGID = b.BACKINGID
              JOIN PROJECT pr ON pr.PROJECTID = bp.PROJECTID
              JOIN CREATOR c  ON c.CREATORID  = pr.CREATORID
            WHERE p.STATUS = 'PAID'
              AND p.CREATEDAT >= #{since}
              AND pr.PROJECTSTATUS = 'OPEN'
              /* startDays가 NULL이면 필터 무시 */
              AND ( #{startDays,jdbcType=NUMERIC} IS NULL
                    OR pr.STARTDATE >= TRUNC(SYSDATE) - #{startDays,jdbcType=NUMERIC} )
            GROUP BY
              pr.PROJECTID, pr.TITLE, pr.THUMBNAIL, pr.CREATORID, c.CREATORNAME,
              pr.CURRAMOUNT, pr.GOALAMOUNT, pr.ENDDATE, pr.LIKECNT, pr.VIEWCNT
            ORDER BY
              (
                (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                      THEN (SUM(p.AMOUNT) / NULLIF(pr.GOALAMOUNT,0)) * 100
                      ELSE 0 END) * 0.7
                + (NVL(pr.LIKECNT,0) / 50.0)  * 0.2
                + (NVL(pr.VIEWCNT,0) / 500.0) * 0.1
              ) DESC
          ) t
          WHERE ROWNUM <= #{limit,jdbcType=NUMERIC}
        ]]>
    </select>


</mapper>
