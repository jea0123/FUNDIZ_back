<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.ProjectMapper">

    <update id="updateViewCnt">
        UPDATE PROJECT
        SET VIEWCNT = VIEWCNT + 1
        WHERE PROJECTID = #{projectId}
    </update>

    <select id="findById" resultType="project">
        SELECT *
        FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </select>

    <select id="findByIds" resultType="project">
        SELECT *
        FROM project
        WHERE projectId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="getProjectRow" resultType="projectRow">
        SELECT
            p.PROJECTID AS projectId,
            p.CREATORID AS creatorId,
            p.SUBCTGRID AS subctgrId,
            p.TITLE AS title,
            p.GOALAMOUNT AS goalAmount,
            p.CURRAMOUNT AS currAmount,
            p.STARTDATE AS startDate,
            p.ENDDATE AS endDate,
            p.CONTENT AS content,
            p.THUMBNAIL AS thumbnail,
            p.PROJECTSTATUS AS projectStatus,
            p.BACKERCNT AS backerCnt,
            p.LIKECNT AS likeCnt,
            p.VIEWCNT AS viewCnt,
            c.CREATORNAME AS creatorName,
            c.FOLLOWERCNT AS followerCnt,
            c.PROFILEIMG AS profileImg,
            sc.SUBCTGRNAME AS subctgrName,
            cg.CTGRNAME AS ctgrName
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        WHERE p.PROJECTID = #{projectId}
    </select>

    <select id="findByIdsAndStatus" resultType="project">
        SELECT *
        FROM project
        WHERE projectId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        AND PROJECTSTATUS = #{status}
    </select>

    <select id="findFeaturedJoinedWithRecent" parameterType="map" resultType="featuredProjectDto">
        <![CDATA[
            SELECT projectId, title, creatorName, thumbnail, endDate, percentNow, goalAmount, score
            FROM (
            SELECT
              pr.PROJECTID AS projectId,
              pr.TITLE AS title,
              NVL2(TRIM(c.CREATORNAME), c.CREATORNAME, 'Unknown Creator') AS creatorName,
              pr.THUMBNAIL AS thumbnail,
              pr.ENDDATE AS endDate,
              /* 진행률(%) */

              CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                   THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                   ELSE 0
              END AS percentNow,
              NVL(pr.GOALAMOUNT,0) AS goalAmount,

              /* 점수: 진행률 35% + 최근결제/목표 15% + 백커/좋아요/조회 */
              (
                (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                      THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                      ELSE 0 END) * 0.35
                + (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                      THEN (NVL(rp.recentPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                      ELSE 0 END) * 0.15
                + (NVL(pr.BACKERCNT,0) / 50.0)  * 0.20
                + (NVL(pr.LIKECNT,0)   / 20.0)  * 0.20
                + (NVL(pr.VIEWCNT,0)   / 500.0) * 0.10
              ) AS score,

              ROW_NUMBER() OVER (
                ORDER BY
                  CASE
                    WHEN pr.STARTDATE >= TRUNC(SYSDATE) - #{days,jdbcType=NUMERIC} THEN 1
                    ELSE 2
                  END ASC,
                  (
                    (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                          THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                          ELSE 0 END) * 0.35
                    + (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                          THEN (NVL(rp.recentPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                          ELSE 0 END) * 0.15
                    + (NVL(pr.BACKERCNT, 0) / 50.0) * 0.20
                    + (NVL(pr.LIKECNT, 0) / 20.0) * 0.20
                    + (NVL(pr.VIEWCNT, 0) / 500.0) * 0.10
                  ) DESC
              ) rn
            FROM PROJECT pr
            JOIN CREATOR c ON c.CREATORID = pr.CREATORID

            /* 최근 결제액 집계: 프로젝트별 recentPaidAmount */
            LEFT JOIN (
              SELECT bp.PROJECTID,
                     SUM(p.AMOUNT) AS recentPaidAmount
              FROM PAYMENT p
              JOIN BACKING b ON b.BACKINGID = p.BACKINGID
              JOIN (
                SELECT DISTINCT bd.BACKINGID, r.PROJECTID
                FROM BACKINGDETAIL bd
                JOIN REWARD r ON r.REWARDID = bd.REWARDID
              ) bp ON bp.BACKINGID = b.BACKINGID
              WHERE p.STATUS = 'PAID'
                AND p.CREATEDAT >= TRUNC(SYSDATE) - #{days,jdbcType=NUMERIC}
              GROUP BY bp.PROJECTID
            ) rp ON rp.PROJECTID = pr.PROJECTID

            WHERE pr.PROJECTSTATUS = 'OPEN'
          )
          WHERE rn <= #{limit,jdbcType=NUMERIC}
          ]]>
    </select>

    <select id="findRecentTopProjectsJoined" parameterType="map" resultType="recentTop10ProjectDto">
        <![CDATA[
            SELECT *
            FROM (
              SELECT
                pr.PROJECTID                                   AS projectId,
                pr.TITLE                                       AS title,
                pr.THUMBNAIL                                   AS thumbnail,
                pr.CREATORID                                   AS creatorId,
                NVL2(TRIM(c.CREATORNAME), c.CREATORNAME, 'Unknown Creator') AS creatorName,
                NVL(pr.CURRAMOUNT,0)                           AS currAmount,
                NVL(pr.GOALAMOUNT,0)                           AS goalAmount,
                pr.ENDDATE                                     AS endDate,
                NVL(pr.LIKECNT,0)                              AS likeCnt,
                NVL(pr.VIEWCNT,0)                              AS viewCnt,

                /* 결제 집계 (없으면 0) */
                NVL(paid.totalPaidAmount, 0)                   AS totalPaidAmount,
                NVL(paid.backerCnt, 0)                         AS backerCnt,
                paid.lastPaidAt                                AS lastPaidAt,

                /* 진행률(%) */
                CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                     THEN ROUND(NVL(pr.CURRAMOUNT,0) / NULLIF(pr.GOALAMOUNT,0) * 100)
                     ELSE 0 END                                AS percentNow,

                /* 트렌드 점수: 결제비중 70% + 좋아요 20% + 조회수 10% */
                ( (CASE WHEN NVL(pr.GOALAMOUNT,0) > 0
                        THEN (NVL(paid.totalPaidAmount,0) / NULLIF(pr.GOALAMOUNT,0)) * 100
                        ELSE 0 END) * 0.7
                  + (NVL(pr.LIKECNT,0)  / 50.0)  * 0.2
                  + (NVL(pr.VIEWCNT,0)  / 500.0) * 0.1
                )                                              AS trendScore
              FROM PROJECT pr
              JOIN CREATOR c ON c.CREATORID = pr.CREATORID

              /* 최근 결제 집계: PAYMENT → BACKING → BACKINGDETAIL → REWARD */
              LEFT JOIN (
                SELECT
                  r.PROJECTID,
                  SUM(p.AMOUNT)                 AS totalPaidAmount,
                  COUNT(DISTINCT b.USERID)      AS backerCnt,
                  MAX(p.CREATEDAT)              AS lastPaidAt
                FROM PAYMENT p
                JOIN BACKING b        ON b.BACKINGID  = p.BACKINGID
                JOIN BACKINGDETAIL bd ON bd.BACKINGID = b.BACKINGID
                JOIN REWARD r         ON r.REWARDID   = bd.REWARDID
                WHERE p.STATUS     = 'PAID'
                  AND p.CREATEDAT >= #{since}   -- 예: SYSDATE-1(최근 24시간)
                GROUP BY r.PROJECTID
              ) paid ON paid.PROJECTID = pr.PROJECTID

              /* 프로젝트 조건 */
              WHERE pr.PROJECTSTATUS = 'OPEN'
                AND (
                  #{startDays,jdbcType=NUMERIC} IS NULL
                  OR pr.STARTDATE IS NULL
                  OR pr.STARTDATE >= TRUNC(SYSDATE) - #{startDays,jdbcType=NUMERIC}  -- 예: 30
                )

              ORDER BY trendScore DESC
            ) t
            WHERE ROWNUM <= #{limit,jdbcType=NUMERIC}
        ]]>
    </select>

    <select id="getProjectCnt" resultType="Integer">
        SELECT COUNT(*)
        FROM PROJECT
        WHERE CREATORID = #{creatorId}
    </select>

    <insert id="saveProject">
        <selectKey keyProperty="projectId" resultType="Long" order="BEFORE">
            SELECT PROJECT_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO PROJECT (
            PROJECTID, CREATORID, SUBCTGRID, TITLE, GOALAMOUNT,
            STARTDATE, ENDDATE, CONTENT, THUMBNAIL
        ) VALUES (
            #{projectId}, #{creatorId}, #{subctgrId}, #{title}, #{goalAmount},
            #{startDate}, #{endDate}, #{content}, #{thumbnail}
        )
    </insert>

    <select id="getStatus" resultType="string">
        SELECT PROJECTSTATUS
        FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </select>
    
    <update id="updateProject">
        UPDATE PROJECT
        <set>
            <if test="subctgrId != null"> SUBCTGRID = #{subctgrId}, </if>
            <if test="title != null"> TITLE = #{title}, </if>
            <if test="content != null"> CONTENT = #{content}, </if>
            <if test="thumbnail != null"> THUMBNAIL = #{thumbnail}, </if>
            <if test="goalAmount != null"> GOALAMOUNT = #{goalAmount}, </if>
            <if test="startDate != null"> STARTDATE = #{startDate}, </if>
            <if test="endDate != null"> ENDDATE = #{endDate}, </if>
            UPDATEDAT = SYSDATE
        </set>
        WHERE PROJECTID = #{projectId}
          AND PROJECTSTATUS IN ('DRAFT')
    </update>

    <delete id="deleteProject">
        DELETE FROM PROJECT
        WHERE PROJECTID = #{projectId}
    </delete>

    <select id="searchProjects" resultType="featuredProjectDto">
        <bind name="startRow" value="(pager.page - 1) * pager.size + 1"/>
        <bind name="endRow" value="pager.page * pager.size"/>

        SELECT *
        FROM (
            SELECT T.*, ROWNUM rnum
            FROM (
                SELECT
                    p.PROJECTID AS projectId,
                    p.TITLE AS title,
                    NVL2(TRIM(c.CREATORNAME), c.CREATORNAME, 'Unknown Creator') AS creatorName,
                    p.THUMBNAIL AS thumbnail,
                    p.ENDDATE AS endDate,
                    p.CURRAMOUNT AS currAmount,

                    /* 진행률(%) */
                    CASE WHEN NVL(p.GOALAMOUNT,0) > 0
                         THEN ROUND(NVL(p.CURRAMOUNT,0) / NULLIF(p.GOALAMOUNT,0) * 100)
                         ELSE 0
                    END AS percentNow,

                    NVL(p.GOALAMOUNT,0) AS goalAmount
                FROM PROJECT p
                JOIN CREATOR c ON c.CREATORID = p.CREATORID
                JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
                JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
                <where>
                    <if test="dto.keyword != null and dto.keyword != ''">
                        (
                        LOWER(p.TITLE) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                        OR LOWER(p.CONTENT) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                        OR LOWER(c.CREATORNAME) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                        OR EXISTS (
                            SELECT 1 FROM TAG t
                            WHERE t.PROJECTID = p.PROJECTID
                              AND LOWER(t.TAGNAME) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                            )
                        )
                    </if>
                    <if test="dto.ctgrId != null">
                        AND cg.CTGRID = #{dto.ctgrId}
                    </if>
                    <if test="dto.subctgrId != null">
                        AND sc.SUBCTGRID = #{dto.subctgrId}
                    </if>
                    <if test="dto.activeOnly != null and dto.activeOnly">
                        AND p.ENDDATE &gt;= SYSDATE
                    </if>
                </where>

                <choose>
                    <when test="dto.sort == 'liked'">
                        ORDER BY p.LIKECNT DESC, P.PROJECTID DESC
                    </when>
                    <when test="dto.sort == 'recent'">
                        ORDER BY p.PROJECTID DESC
                    </when>
                    <when test="dto.sort == 'amount'">
                        ORDER BY p.CURRAMOUNT DESC, P.PROJECTID DESC
                    </when>
                    <when test="dto.sort == 'deadline'">
                        ORDER BY p.ENDDATE ASC, P.PROJECTID DESC
                    </when>
                    <when test="dto.sort == 'percent'">
                        ORDER BY percentNow DESC, P.PROJECTID DESC
                    </when>
                    <otherwise>
                        ORDER BY p.VIEWCNT DESC, p.PROJECTID DESC
                    </otherwise>
                </choose>
                ) T
            WHERE ROWNUM &lt;= #{endRow}
            )
        WHERE rnum &gt;= #{startRow}

    </select>

    <select id="countSearchProjects" resultType="int">
        SELECT COUNT(*)
        FROM PROJECT p
        JOIN CREATOR c ON c.CREATORID = p.CREATORID
        JOIN SUBCATEGORY sc ON sc.SUBCTGRID = p.SUBCTGRID
        JOIN CATEGORY cg ON cg.CTGRID = sc.CTGRID
        <where>
            <if test="dto.keyword != null and dto.keyword != ''">
                (
                LOWER(p.TITLE) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                OR LOWER(p.CONTENT) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                OR LOWER(c.CREATORNAME) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                OR EXISTS (
                    SELECT 1 FROM TAG t
                    WHERE t.PROJECTID = p.PROJECTID
                    AND LOWER(t.TAGNAME) LIKE '%' || LOWER(#{dto.keyword}) || '%'
                    )
                )
            </if>
            <if test="dto.ctgrId != null">
                AND cg.CTGRID = #{dto.ctgrId}
            </if>
            <if test="dto.subctgrId != null">
                AND sc.SUBCTGRID = #{dto.subctgrId}
            </if>
            <if test="dto.activeOnly != null and dto.activeOnly">
                AND p.ENDDATE &gt;= SYSDATE
            </if>
        </where>
    </select>

</mapper>
