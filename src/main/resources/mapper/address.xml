<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.AddressMapper">

    <select id="getAddressList" parameterType="long" resultType = "com.example.funding.dto.response.address.AddressResponseDto">
        SELECT
            a.addrId,
            a.userId,
            a.addrName,
            a.recipient,
            a.postalCode,
            a.roadAddr,
            a.detailAddr,
            a.recipientPhone,
            a.isDefault

        FROM address a
        WHERE a.userId=#{userId}
        Order BY addrId DESC
    </select>

    <insert id="addAddr" parameterType="com.example.funding.dto.request.address.AddrAddRequestDto">
        <selectKey keyProperty="addrId" resultType="Long" order="BEFORE">
            SELECT ADDRESS_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO ADDRESS (
        ADDRID, USERID, ADDRNAME, RECIPIENT, POSTALCODE, ROADADDR,
        DETAILADDR, RECIPIENTPHONE, ISDEFAULT
        ) VALUES (
        #{addrId}, #{userId}, #{addrName}, #{recipient}, #{postalCode}, #{roadAddr},
        #{detailAddr}, #{recipientPhone},
        case
            when(select count(*) from address where userId = #{userId}) = 0
            then 'Y'
            ELSE 'N'
        END
        )
        from dual
        where (select count(*) from address where userId = #{userId}) &lt;= 5
    </insert>

    <update id="resetDefaultAddr">
        UPDATE ADDRESS
        SET ISDEFAULT =CASE
                        WHEN ADDRID = #{addrId} THEN 'Y' ELSE 'N' END
        WHERE USERID = #{userId}
    </update>

    <update id="updateAddr" parameterType="com.example.funding.dto.request.address.AddrUpdateRequestDto">
        UPDATE ADDRESS
        SET ADDRNAME =#{addrName},
            RECIPIENT = #{recipient},
            POSTALCODE = #{postalCode},
            ROADADDR = #{roadAddr},
            DETAILADDR = #{detailAddr},
            RECIPIENTPHONE = #{recipientPhone}
        WHERE USERID = #{userId}
        AND ADDRID = #{addrId}
    </update>

    <delete id="deleteAddr">
        DELETE FROM ADDRESS
        WHERE USERID = #{userId}
        AND ADDRID = #{addrId}
    </delete>

    <select id="getAddr" resultType="address" parameterType="long">
        SELECT *
        FROM address a
        WHERE a.addrId=#{addrId}
    </select>

</mapper>