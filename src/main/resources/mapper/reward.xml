<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.RewardMapper">

    <select id="getRewardList" resultType="reward">
        SELECT
            r.REWARDID,
            r.PROJECTID,
            r.REWARDNAME,
            r.PRICE,
            r.REWARDCONTENT,
            r.DELIVERYDATE,
            r.REWARDCNT,
            r.CREATEDAT,
            r.ISPOSTING,
            CASE
                WHEN r.REWARDCNT IS NULL THEN NULL
                ELSE GREATEST(r.REWARDCNT - NVL(s.qty, 0), 0)
            END AS REMAIN
        FROM reward r
        LEFT JOIN (
            SELECT
                d.REWARDID, SUM(d.QUANTITY) AS qty
            FROM BACKINGDETAIL d
            JOIN BACKING b ON b.BACKINGID = d.BACKINGID
              AND b.BACKINGSTATUS = 'COMPLETED'
            GROUP BY d.REWARDID
        ) s ON s.REWARDID = r.REWARDID
        WHERE r.PROJECTID = #{projectId}
        ORDER BY r.PRICE
    </select>

    <select id="findByProjectId" resultType="reward">
        SELECT * FROM REWARD
        WHERE PROJECTID = #{projectId}
    </select>

    <select id="findProjectIdsByRewardIds" resultType="reward">
        SELECT *
        FROM reward
        WHERE rewardId IN
        <foreach collection="ids" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <insert id="saveReward">
        <selectKey keyProperty="rewardId" resultType="Long" order="BEFORE">
            SELECT REWARD_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO REWARD (
            REWARDID,
            PROJECTID,
            REWARDNAME,
            PRICE,
            REWARDCONTENT,
            DELIVERYDATE,
            <if test="rewardCnt != null">REWARDCNT,</if>
            ISPOSTING
        ) VALUES (
            #{rewardId},
            #{projectId},
            #{rewardName},
            #{price},
            #{rewardContent},
            #{deliveryDate},
            <if test="rewardCnt != null">#{rewardCnt},</if>
            #{isPosting}
        )
    </insert>

    <delete id="deleteReward">
        DELETE FROM REWARD
        WHERE PROJECTID = #{projectId}
          AND REWARDID = #{rewardId}
    </delete>

    <delete id="deleteRewards">
        DELETE FROM REWARD
        WHERE PROJECTID = #{projectId}
    </delete>

    <select id="getCreatorRewardList" resultType="reward">
        SELECT
            r.REWARDID,
            r.PROJECTID,
            r.REWARDNAME,
            r.PRICE,
            r.REWARDCONTENT,
            r.DELIVERYDATE,
            r.REWARDCNT,
            r.CREATEDAT,
            r.ISPOSTING,
            CASE
                WHEN r.REWARDCNT IS NULL THEN NULL
                ELSE GREATEST(r.REWARDCNT - NVL(s.qty, 0), 0)
            END AS REMAIN
        FROM reward r
        LEFT JOIN (
            SELECT
                d.REWARDID, SUM(d.QUANTITY) AS qty
            FROM BACKINGDETAIL d
            JOIN BACKING b ON b.BACKINGID = d.BACKINGID
                AND b.BACKINGSTATUS = 'COMPLETED'
            GROUP BY d.REWARDID
        ) s ON s.REWARDID = r.REWARDID
        JOIN PROJECT p ON p.PROJECTID = r.PROJECTID
        WHERE r.PROJECTID = #{projectId}
        AND p.CREATORID = #{creatorId}
        ORDER BY r.CREATEDAT
    </select>

    <select id="existsByProjectIdAndNameNormalized" resultType="boolean">
        SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
        FROM REWARD
        WHERE PROJECTID = #{projectId}
        AND LOWER(REGEXP_REPLACE(TRIM(REWARDNAME), '\s+', ' ')) = #{normalizedName}
        AND NVL(DEL_YN,'N') = 'N'
    </select>

    <select id="findById" resultType="reward">
        SELECT * FROM REWARD
        WHERE REWARDID = #{rewardId}
    </select>

    <select id="getMyPageDetailRewardList" resultType = "com.example.funding.dto.response.backing.userList_detail.MyPageBacking_RewardDto">
        select
            p.projectId,
            r.rewardName,
            b.backingId,
            b.userId
        from reward r
        JOIN project p ON r.projectId = p.projectId
        JOIN backingDetail bd ON bd.rewardId = r.rewardId
        JOIN backing b ON b.backingId = bd.backingId
        where b.backingId = #{backingId}
    </select>

    <select id="getMyPageDetailRewardDetail" resultType = "com.example.funding.dto.response.backing.userList_detail.MyPageBacking_RewardDto">
        select
        p.projectId,
        r.rewardName,
        r.price,
        r.deliveryDate,
        bd.quantity,
        b.backingId,
        b.userId
        from reward r
        JOIN project p ON r.projectId = p.projectId
        JOIN backingDetail bd ON bd.rewardId = r.rewardId
        JOIN backing b ON b.backingId = bd.backingId
        where b.backingId = #{backingId}
    </select>

</mapper>
