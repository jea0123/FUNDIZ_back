<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.UserMapper">

    <insert id="signUp" parameterType="user">
        INSERT INTO USERS (USERID, EMAIL, PWD, NICKNAME)
        VALUES
        (USERS_SEQ.NEXTVAL, #{email}, #{pwd}, #{nickname})
    </insert>

    <update id="updateLastLogin" parameterType="Long">
        UPDATE USERS
        SET LASTLOGINAT = SYSDATE
        WHERE USERID = #{userId}
    </update>

    <select id="getUserById" parameterType="long" resultType="com.example.funding.model.User">
        SELECT userId, email, pwd, nickname, profileImg, isSuspended, joinedAt, lastLoginAt, followCnt, reason,
        suspendedAt, releasedAt, isCreator, role
        FROM users
        WHERE userId=#{userId, jdbcType=NUMERIC}
    </select>

    <select id="findByEmail" parameterType="String" resultType="user">
        SELECT userId, email, pwd, nickname, profileImg, isSuspended, joinedAt, lastLoginAt, followCnt, reason,
        suspendedAt, releasedAt, isCreator, role
        FROM USERS WHERE EMAIL = #{email}
    </select>

    <select id="findByNickname" parameterType="String" resultType="user">
        SELECT * FROM USERS WHERE NICKNAME = #{nickname}
    </select>

    <update id="upsertRecentView" parameterType="map">
        MERGE INTO recentview rv
        USING (
        SELECT
        #{userId, jdbcType=NUMERIC} AS userId,
        #{projectId, jdbcType=NUMERIC} AS projectId
        FROM dual
        ) src
        ON (rv.userId = src.userId AND rv.projectId = src.projectId)
        WHEN MATCHED THEN
        UPDATE SET rv.viewedAt = SYSDATE
        WHEN NOT MATCHED THEN
        INSERT (userId, projectId, viewedAt)
        VALUES (src.userId, src.projectId, SYSDATE)
    </update>

    <select id="getRecentViewProjects" resultType="recentViewProject">
        SELECT *
        FROM (
        SELECT
        pr.projectId,
        NVL2(TRIM(c.creatorName), c.creatorName, 'Unknown Creator') AS creatorName,
        pr.Title,
        pr.Thumbnail,
        CASE WHEN NVL(pr.goalAmount,0) > 0
        THEN ROUND(NVL(pr.currAmount,0) / NULLIF(pr.goalAmount,0) * 100)
        ELSE 0 END AS percentNow,
        pr.currAmount,
        pr.endDate,
        rv.viewedAt
        FROM recentview rv
        JOIN project pr ON rv.projectId = pr.projectId
        JOIN creator c ON pr.creatorId = c.creatorId
        WHERE rv.userId = #{userId}
        ORDER BY rv.viewedAt DESC
        )
        <![CDATA[
            WHERE ROWNUM <= #{limit}
        ]]>
    </select>

    <select id="getCreatorIdByUserId" resultType="long">
        SELECT creatorId
        FROM creator
        WHERE userId = #{userId}
    </select>

    <update id="updateNickname">
        UPDATE USERS
        SET nickname = #{nickname}
        WHERE userId = #{userId}
    </update>

    <update id="updatePwd">
        UPDATE USERS
        SET pwd = #{password}
        WHERE userId = #{userId}
    </update>

    <update id="updateProfile">
        UPDATE USERS
        SET profileImg = #{profileImg}
        WHERE userId = #{userId}
    </update>

    <delete id="withdrawUser" parameterType="long">
        DELETE FROM USERS
        WHERE USERID = #{userId}
    </delete>

    <select id="getLastLoginTime" resultType="java.time.LocalDateTime" parameterType="long">
        SELECT LASTLOGINAT
        FROM USERS
        WHERE USERID = #{userId}
    </select>

    <select id="selectUsersByIds" parameterType="list"
            resultType="com.example.funding.dto.response.creator.ReviewListDto$UserInfo">
        SELECT
        u.userId AS userId,
        u.nickname AS nickname,
        u.profileImg AS profileImg
        FROM users u
        WHERE u.userId IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </select>

    <select id="findUserSummary" resultType="userSummaryDto">
        SELECT
        u.userId,
        (SELECT COUNT(DISTINCT b.backingId)
        FROM backing b
        WHERE b.userId = u.userId) AS backingCount,
        (SELECT COUNT(DISTINCT l.projectId)
        FROM liked l
        WHERE l.userId = u.userId) AS likedCount,
        (SELECT COUNT(DISTINCT f.creatorId)
        FROM follow f
        WHERE f.userId = u.userId) AS followCreatorCount,
        (SELECT COUNT(*)
        FROM notification n
        WHERE n.userId = u.userId
        AND n.isRead = 'N') AS notificationCount
        FROM users u
        WHERE u.userId = #{userId}
    </select>
</mapper>