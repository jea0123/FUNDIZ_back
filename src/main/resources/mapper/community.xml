<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.funding.mapper.CommunityMapper">

    <!-- START 커뮤니티/후기 목록 -->
    <sql id="foldedQuery">
        WITH base AS (
        SELECT /*+ MATERIALIZE */
        CMID, USERID, PROJECTID, CMCONTENT, NVL(RATING, 0) AS RATING, CREATEDAT, CODE
        FROM (
        SELECT
        CMID, USERID, PROJECTID, CMCONTENT, NVL(RATING, 0) AS RATING, CREATEDAT, CODE
        FROM COMMUNITY
        WHERE PROJECTID = #{projectId}
        AND TRIM(CODE) = #{code}
        <if test="lastCreatedAt != null">
            <![CDATA[
                    AND (
                        CREATEDAT < #{lastCreatedAt}
                        OR (CREATEDAT = #{lastCreatedAt} AND CMID < #{lastId})
                    )
                ]]>
        </if>
        ORDER BY CREATEDAT DESC, CMID DESC
        )
        WHERE ROWNUM <![CDATA[ <= ]]> #{size}
        )
        SELECT
        b.CMID AS cmId,
        b.PROJECTID AS projectId,
        b.CMCONTENT AS cmContent,
        b.CREATEDAT AS createdAt,
        b.CODE AS code,
        b.RATING AS rating,
        u.NICKNAME AS nickname,
        u.PROFILEIMG AS profileImg
        FROM base b
        LEFT JOIN USERS u ON u.USERID = b.USERID
        ORDER BY b.CREATEDAT DESC, b.CMID DESC
    </sql>

    <select id="getCommunityList" resultType="communityDto">
        <include refid="foldedQuery"/>
    </select>

    <select id="getReviewList" resultType="reviewDto">
        <include refid="foldedQuery"/>
    </select>
    <!-- END 커뮤니티/후기 목록 -->

    <insert id="createCommunity">
        <selectKey keyProperty="cmId" resultType="Long" order="BEFORE">
            SELECT COMMUNITY_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO COMMUNITY (CMID, USERID, PROJECTID, CMCONTENT, CODE)
        VALUES (#{cmId}, #{userId}, #{projectId}, #{cmContent}, 'CM')
    </insert>

    <select id="existsCommunityById" resultType="int">
        SELECT COUNT(*) FROM COMMUNITY
        WHERE CMID = #{cmId}
    </select>

    <select id="getCommunityById" resultType="community">
        SELECT *
        FROM COMMUNITY
        WHERE CMID = #{cmId}
    </select>

    <select id="findCreatorCommunityIds" resultType="long" parameterType="map">
        SELECT cm.cmId
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}
        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>
        <if test="lastCreatedAt != null and lastId != null">
            AND (
            cm.createdAt &lt; #{lastCreatedAt, jdbcType=TIMESTAMP}
            OR (cm.createdAt = #{lastCreatedAt, jdbcType=TIMESTAMP} AND cm.cmId &lt; #{lastId})
            )
        </if>
        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>
        ORDER BY cm.createdAt DESC, cm.cmId DESC
        FETCH FIRST #{limit} ROWS ONLY
    </select>

    <select id="findCreatorCommunityWindow" parameterType="map" resultType="map">
        SELECT *
        FROM (
        SELECT
        cm.cmId AS cmId,
        cm.userId AS userId,
        cm.projectId AS projectId,
        cm.cmContent AS cmContent,
        CAST(cm.createdAt AS TIMESTAMP) AS createdAt
        FROM community cm
        JOIN project p ON p.projectId = cm.projectId
        WHERE p.creatorId = #{creatorId}

        <if test="projectId != null">
            AND p.projectId = #{projectId}
        </if>

        <if test="lastCreatedAt != null and lastId != null">
            AND (
            cm.createdAt &lt; #{lastCreatedAt, jdbcType=TIMESTAMP}
            OR (cm.createdAt = #{lastCreatedAt, jdbcType=TIMESTAMP}
            AND cm.cmId &lt; #{lastId})
            )
        </if>

        <if test="photoOnly != null and photoOnly">
            AND EXISTS (
            SELECT 1 FROM attach a
            WHERE a.cmId = cm.cmId
            AND a.code = 'CM'
            )
        </if>

        ORDER BY cm.createdAt DESC, cm.cmId DESC
        )
        WHERE ROWNUM &lt;= #{limit}
    </select>

    <select id="selectReviewImagesByCmIds" parameterType="list" resultType="map">
        SELECT
        a.cmId AS cmId,
        (a.filePath || a.fileName) AS url
        FROM attach a
        WHERE a.code = 'CM'
        AND a.cmId IN
        <foreach collection="list" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
        ORDER BY a.cmId, a.attachId
    </select>
</mapper>
